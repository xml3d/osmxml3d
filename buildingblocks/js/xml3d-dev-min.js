var XML3D=XML3D||{};XML3D.version="DEVELOPMENT SNAPSHOT / 61514f5 / 2012-05-14 09:12:22 +0200";XML3D.xml3dNS="http://www.xml3d.org/2009/xml3d";XML3D.xhtmlNS="http://www.w3.org/1999/xhtml";XML3D.webglNS="http://www.xml3d.org/2009/xml3d/webgl";XML3D._xml3d=document.createElementNS(XML3D.xml3dNS,"xml3d");XML3D._native=!!XML3D._xml3d.style;XML3D.extend=function(b,a){for(var c in a)if(void 0===a[c])delete b[c];else if("constructor"!==c||b!==window)b[c]=a[c];return b};
XML3D.createClass=function(b,a,c){c=c||{};if(a){var d=function(){};d.prototype=a.prototype;b.prototype=new d;b.prototype.constructor=b;b.superclass=a.prototype}for(var e in c)b.prototype[e]=c[e];return b};
(function(){var b=function(){if(XML3D.document)XML3D.document.onunload()};window.addEventListener("load",function(){var a=XML3D.debug.setup();a&&XML3D.debug.logInfo("xml3d.js version: "+XML3D.version);var b=document.getElementsByTagNameNS(XML3D.xml3dNS,"xml3d"),b=Array.map(b,function(a){return a});a&&XML3D.debug.logInfo("Found "+b.length+" xml3d nodes...");if(b.length&&XML3D._native)a&&XML3D.debug.logInfo("Using native implementation.");else if(!XML3D.webgl||!XML3D.webgl.supported()){a&&XML3D.debug.logWarning("Could not initialise WebGL, sorry :-(");
for(a=0;a<b.length;a++){var d=document.createElementNS(XML3D.xhtmlNS,"div"),e=b[a];e.parentNode.insertBefore(d,e);d.appendChild(e);d.style.display="none";var g=document.createElementNS(XML3D.xhtmlNS,"div");g.setAttribute("class",e.getAttribute("class"));g.setAttribute("style",e.getAttribute("style"));g.style.border="2px solid red";g.style.color="red";g.style.padding="10px";g.style.backgroundColor="rgba(255, 0, 0, 0.3)";var f=e.getAttribute("width");null!==f&&(g.style.width=f);e=e.getAttribute("height");
null!==e&&(g.style.height=e);e=document.createElement("h3");f=document.createTextNode("Your browser doesn't appear to support XML3D.");e.appendChild(f);f=document.createElement("p");f.appendChild(document.createTextNode("Please visit "));var h=document.createElement("a");h.setAttribute("href","http://www.xml3d.org");h.appendChild(document.createTextNode("http://www.xml3d.org"));f.appendChild(h);f.appendChild(document.createTextNode(" to get information about browsers supporting XML3D."));g.appendChild(e);
g.appendChild(f);d.parentNode.insertBefore(g,d)}}else{XML3D.config.configure(b);try{XML3D.webgl.configure(b)}catch(i){a&&XML3D.debug.logError(i)}(function(a){var b=null;document.createEvent?(b=document.createEvent("Events"),b.initEvent(a,!0,!0),document.dispatchEvent(b)):document.createEventObject&&(b=document.createEventObject(),document.fireEvent("on"+a,b))})("load")}},!1);window.addEventListener("unload",b,!1);window.addEventListener("reload",b,!1)})();XML3D.util=XML3D.util||{};XML3D.util.getStyle=function(b,a){var c="";document.defaultView&&document.defaultView.getComputedStyle?c=document.defaultView.getComputedStyle(b,"").getPropertyValue(a):b.currentStyle&&(a=a.replace(/\-(\w)/g,function(a,b){return b.toUpperCase()}),c=b.currentStyle[a]);return c};
XML3D.setParameter=function(b,a,c){if(b=document.getElementById(b))for(var b=b.childNodes,d=0;d<b.length;d++){var e=b[d];if(e.nodeType===Node.ELEMENT_NODE&&e.name==a&&"string"===typeof c){for(;e.hasChildNodes();)e.removeChild(e.lastChild);e.appendChild(document.createTextNode(c));return!0}}return!1};
window.requestAnimFrame=function(b,a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(){window.setTimeout(b,1E3/a)}}();Array.forEach||(Array.forEach=function(b,a,c){for(var d=b.length,e=0;e<d;e++)e in b&&a.call(c,b[e],e,b)});Array.map||(Array.map=function(b,a,c){for(var d=b.length,e=[],g=0;g<d;g++)g in b&&(e[g]=a.call(c,b[g],g,b));return e});Array.filter||(Array.filter=function(b,a,c){for(var d=b.length,e=[],g=0;g<d;g++)if(g in b){var f=b[g];a.call(c,f,g,b)&&e.push(f)}return e});Array.isArray||(Array.isArray=function(b){return Object.prototype.toString.call(b)=="[object Array]"});XML3D.debug={ALL:0,DEBUG:1,INFO:2,WARNING:3,ERROR:4,EXCEPTION:5,params:{},isSetup:!1,loglevel:4,loglevels:{all:0,debug:1,info:2,warning:3,error:4,exception:5},setup:function(){var b=XML3D.debug;b.isSetup||(window.location.search.substr(1).split("&").forEach(function(a){a=a.split("=");b.params[a[0].toLowerCase()]=decodeURIComponent(a[1])}),b.loglevel=b.loglevels[b.params.xml3d_loglevel]||b.params.xml3d_loglevel||b.loglevels.error,XML3D.debug.isSetup=!0);return!XML3D.debug.params.xml3d_nolog},doLog:function(b,
a){if(!(XML3D.debug.params.xml3d_nolog||a<XML3D.debug.loglevel)&&window.console)switch(a){case XML3D.debug.INFO:window.console.info(b);break;case XML3D.debug.WARNING:window.console.warn(b);break;case XML3D.debug.ERROR:window.console.error(b);break;case XML3D.debug.EXCEPTION:window.console.debug(b);break;case XML3D.debug.DEBUG:window.console.debug(b)}},logDebug:function(b){XML3D.debug.doLog(b,XML3D.debug.DEBUG)},logInfo:function(b){XML3D.debug.doLog(b,XML3D.debug.INFO)},logWarning:function(b){XML3D.debug.doLog(b,
XML3D.debug.WARNING)},logError:function(b){XML3D.debug.doLog(b,XML3D.debug.ERROR)},logException:function(b){XML3D.debug.doLog(b,XML3D.debug.EXCEPTION)},assert:function(b,a){b||XML3D.debug.doLog("Assertion failed in "+XML3D.debug.assert.caller.name+": "+a,XML3D.debug.WARNING)}};XML3D.URI=function(b){b=(b||"").match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/);this.valid=null!=b;this.scheme=b[1]||null;this.authority=b[2]||null;this.path=b[3]||null;this.query=b[4]||null;this.fragment=b[5]||null};XML3D.URI.prototype.toString=function(){var b="";this.scheme&&(b+=this.scheme+":");this.authority&&(b+="//"+this.authority);this.path&&(b+=this.path);this.query&&(b+="?"+this.query);this.fragment&&(b+="#"+this.fragment);return b};
XML3D.URIResolver=function(){};XML3D.URIResolver.resolve=function(b,a){"string"==typeof b&&(b=new XML3D.URI(b));a=a||window.document;if("urn"==b.scheme)return XML3D.debug.logInfo("++ Found URN."+b),null;if(!b.path&&b.fragment)return a.getElementById(b.fragment);XML3D.debug.logWarning("++ Can't resolve URI: "+b.toString());return null};var GLU={};
(function(b){b.unProject=function(a,c,d,e,g,f,h){a=[a,c,d,1];c=[];b.multMatrices(e,g,c);if(!b.invertMatrix(c,c))return!1;a[0]=(a[0]-f[0])/f[2];a[1]=(a[1]-f[1])/f[3];a[0]=2*a[0]-1;a[1]=2*a[1]-1;a[2]=2*a[2]-1;e=[];b.multMatrixVec(c,a,e);if(0===e[3])return!1;e[0]/=e[3];e[1]/=e[3];e[2]/=e[3];h[0]=e[0];h[1]=e[1];h[2]=e[2];return!0};b.multMatrixVec=function(a,b,d){for(var e=0;4>e;e+=1)d[e]=b[0]*a[0+e]+b[1]*a[4+e]+b[2]*a[8+e]+b[3]*a[12+e]};b.multMatrices=function(a,b,d){for(var e=0;4>e;e+=1)for(var g=0;4>
g;g+=1)d[4*e+g]=a[4*e+0]*b[0+g]+a[4*e+1]*b[4+g]+a[4*e+2]*b[8+g]+a[4*e+3]*b[12+g]};b.invertMatrix=function(a,b){var d=[];d[0]=a[5]*a[10]*a[15]-a[5]*a[11]*a[14]-a[9]*a[6]*a[15]+a[9]*a[7]*a[14]+a[13]*a[6]*a[11]-a[13]*a[7]*a[10];d[4]=-a[4]*a[10]*a[15]+a[4]*a[11]*a[14]+a[8]*a[6]*a[15]-a[8]*a[7]*a[14]-a[12]*a[6]*a[11]+a[12]*a[7]*a[10];d[8]=a[4]*a[9]*a[15]-a[4]*a[11]*a[13]-a[8]*a[5]*a[15]+a[8]*a[7]*a[13]+a[12]*a[5]*a[11]-a[12]*a[7]*a[9];d[12]=-a[4]*a[9]*a[14]+a[4]*a[10]*a[13]+a[8]*a[5]*a[14]-a[8]*a[6]*a[13]-
a[12]*a[5]*a[10]+a[12]*a[6]*a[9];d[1]=-a[1]*a[10]*a[15]+a[1]*a[11]*a[14]+a[9]*a[2]*a[15]-a[9]*a[3]*a[14]-a[13]*a[2]*a[11]+a[13]*a[3]*a[10];d[5]=a[0]*a[10]*a[15]-a[0]*a[11]*a[14]-a[8]*a[2]*a[15]+a[8]*a[3]*a[14]+a[12]*a[2]*a[11]-a[12]*a[3]*a[10];d[9]=-a[0]*a[9]*a[15]+a[0]*a[11]*a[13]+a[8]*a[1]*a[15]-a[8]*a[3]*a[13]-a[12]*a[1]*a[11]+a[12]*a[3]*a[9];d[13]=a[0]*a[9]*a[14]-a[0]*a[10]*a[13]-a[8]*a[1]*a[14]+a[8]*a[2]*a[13]+a[12]*a[1]*a[10]-a[12]*a[2]*a[9];d[2]=a[1]*a[6]*a[15]-a[1]*a[7]*a[14]-a[5]*a[2]*a[15]+
a[5]*a[3]*a[14]+a[13]*a[2]*a[7]-a[13]*a[3]*a[6];d[6]=-a[0]*a[6]*a[15]+a[0]*a[7]*a[14]+a[4]*a[2]*a[15]-a[4]*a[3]*a[14]-a[12]*a[2]*a[7]+a[12]*a[3]*a[6];d[10]=a[0]*a[5]*a[15]-a[0]*a[7]*a[13]-a[4]*a[1]*a[15]+a[4]*a[3]*a[13]+a[12]*a[1]*a[7]-a[12]*a[3]*a[5];d[14]=-a[0]*a[5]*a[14]+a[0]*a[6]*a[13]+a[4]*a[1]*a[14]-a[4]*a[2]*a[13]-a[12]*a[1]*a[6]+a[12]*a[2]*a[5];d[3]=-a[1]*a[6]*a[11]+a[1]*a[7]*a[10]+a[5]*a[2]*a[11]-a[5]*a[3]*a[10]-a[9]*a[2]*a[7]+a[9]*a[3]*a[6];d[7]=a[0]*a[6]*a[11]-a[0]*a[7]*a[10]-a[4]*a[2]*
a[11]+a[4]*a[3]*a[10]+a[8]*a[2]*a[7]-a[8]*a[3]*a[6];d[11]=-a[0]*a[5]*a[11]+a[0]*a[7]*a[9]+a[4]*a[1]*a[11]-a[4]*a[3]*a[9]-a[8]*a[1]*a[7]+a[8]*a[3]*a[5];d[15]=a[0]*a[5]*a[10]-a[0]*a[6]*a[9]-a[4]*a[1]*a[10]+a[4]*a[2]*a[9]+a[8]*a[1]*a[6]-a[8]*a[2]*a[5];var e=a[0]*d[0]+a[1]*d[4]+a[2]*d[8]+a[3]*d[12];if(0===e)return!1;for(var e=1/e,g=0;16>g;g+=1)b[g]=d[g]*e;return!0}})(GLU);var glMatrixArrayType;glMatrixArrayType="undefined"!=typeof Float32Array?Float32Array:Array;
var vec3={create:function(b){var a=new glMatrixArrayType(3);b&&(a[0]=b[0],a[1]=b[1],a[2]=b[2]);return a},set:function(b,a){a[0]=b[0];a[1]=b[1];a[2]=b[2];return a},add:function(b,a,c){if(!c||b==c)return b[0]+=a[0],b[1]+=a[1],b[2]+=a[2],b;c[0]=b[0]+a[0];c[1]=b[1]+a[1];c[2]=b[2]+a[2];return c},subtract:function(b,a,c){if(!c||b==c)return b[0]-=a[0],b[1]-=a[1],b[2]-=a[2],b;c[0]=b[0]-a[0];c[1]=b[1]-a[1];c[2]=b[2]-a[2];return c},negate:function(b,a){a||(a=b);a[0]=-b[0];a[1]=-b[1];a[2]=-b[2];return a},scale:function(b,
a,c){if(!c||b==c)return b[0]*=a,b[1]*=a,b[2]*=a,b;c[0]=b[0]*a;c[1]=b[1]*a;c[2]=b[2]*a;return c},normalize:function(b,a){a||(a=b);var c=b[0],d=b[1],e=b[2],g=Math.sqrt(c*c+d*d+e*e);if(!g)return a[0]=0,a[1]=0,a[2]=0,a;if(1==g)return a[0]=c,a[1]=d,a[2]=e,a;g=1/g;a[0]=c*g;a[1]=d*g;a[2]=e*g;return a},cross:function(b,a,c){c||(c=b);var d=b[0],e=b[1],b=b[2],g=a[0],f=a[1],a=a[2];c[0]=e*a-b*f;c[1]=b*g-d*a;c[2]=d*f-e*g;return c},length:function(b){var a=b[0],c=b[1],b=b[2];return Math.sqrt(a*a+c*c+b*b)},dot:function(b,
a){return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]},direction:function(b,a,c){c||(c=b);var d=b[0]-a[0],e=b[1]-a[1],b=b[2]-a[2],a=Math.sqrt(d*d+e*e+b*b);if(!a)return c[0]=0,c[1]=0,c[2]=0,c;a=1/a;c[0]=d*a;c[1]=e*a;c[2]=b*a;return c},lerp:function(b,a,c,d){d||(d=b);d[0]=b[0]+c*(a[0]-b[0]);d[1]=b[1]+c*(a[1]-b[1]);d[2]=b[2]+c*(a[2]-b[2]);return d},str:function(b){return"["+b[0]+", "+b[1]+", "+b[2]+"]"}},mat3={create:function(b){var a=new glMatrixArrayType(9);b&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],
a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9]);return a},set:function(b,a){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];return a},identity:function(b){b[0]=1;b[1]=0;b[2]=0;b[3]=0;b[4]=1;b[5]=0;b[6]=0;b[7]=0;b[8]=1;return b},transpose:function(b,a){if(!a||b==a){var c=b[1],d=b[2],e=b[5];b[1]=b[3];b[2]=b[6];b[3]=c;b[5]=b[7];b[6]=d;b[7]=e;return b}a[0]=b[0];a[1]=b[3];a[2]=b[6];a[3]=b[1];a[4]=b[4];a[5]=b[7];a[6]=b[2];a[7]=b[5];a[8]=b[8];return a},toMat4:function(b,
a){a||(a=mat4.create());a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=0;a[4]=b[3];a[5]=b[4];a[6]=b[5];a[7]=0;a[8]=b[6];a[9]=b[7];a[10]=b[8];a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},str:function(b){return"["+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+", "+b[4]+", "+b[5]+", "+b[6]+", "+b[7]+", "+b[8]+"]"}},mat4={create:function(b){var a=new glMatrixArrayType(16);b&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],
a[14]=b[14],a[15]=b[15]);return a},set:function(b,a){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];a[9]=b[9];a[10]=b[10];a[11]=b[11];a[12]=b[12];a[13]=b[13];a[14]=b[14];a[15]=b[15];return a},identity:function(b){b[0]=1;b[1]=0;b[2]=0;b[3]=0;b[4]=0;b[5]=1;b[6]=0;b[7]=0;b[8]=0;b[9]=0;b[10]=1;b[11]=0;b[12]=0;b[13]=0;b[14]=0;b[15]=1;return b},transpose:function(b,a){if(!a||b==a){var c=b[1],d=b[2],e=b[3],g=b[6],f=b[7],h=b[11];b[1]=b[4];b[2]=b[8];b[3]=b[12];b[4]=
c;b[6]=b[9];b[7]=b[13];b[8]=d;b[9]=g;b[11]=b[14];b[12]=e;b[13]=f;b[14]=h;return b}a[0]=b[0];a[1]=b[4];a[2]=b[8];a[3]=b[12];a[4]=b[1];a[5]=b[5];a[6]=b[9];a[7]=b[13];a[8]=b[2];a[9]=b[6];a[10]=b[10];a[11]=b[14];a[12]=b[3];a[13]=b[7];a[14]=b[11];a[15]=b[15];return a},determinant:function(b){var a=b[0],c=b[1],d=b[2],e=b[3],g=b[4],f=b[5],h=b[6],i=b[7],j=b[8],k=b[9],l=b[10],n=b[11],o=b[12],m=b[13],p=b[14],b=b[15];return o*k*h*e-j*m*h*e-o*f*l*e+g*m*l*e+j*f*p*e-g*k*p*e-o*k*d*i+j*m*d*i+o*c*l*i-a*m*l*i-j*c*
p*i+a*k*p*i+o*f*d*n-g*m*d*n-o*c*h*n+a*m*h*n+g*c*p*n-a*f*p*n-j*f*d*b+g*k*d*b+j*c*h*b-a*k*h*b-g*c*l*b+a*f*l*b},inverse:function(b,a){a||(a=b);var c=b[0],d=b[1],e=b[2],g=b[3],f=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],n=b[10],o=b[11],m=b[12],p=b[13],r=b[14],u=b[15],v=c*h-d*f,s=c*i-e*f,w=c*j-g*f,t=d*i-e*h,q=d*j-g*h,y=e*j-g*i,z=k*p-l*m,A=k*r-n*m,B=k*u-o*m,C=l*r-n*p,D=l*u-o*p,E=n*u-o*r,x=1/(v*E-s*D+w*C+t*B-q*A+y*z);a[0]=(h*E-i*D+j*C)*x;a[1]=(-d*E+e*D-g*C)*x;a[2]=(p*y-r*q+u*t)*x;a[3]=(-l*y+n*q-o*t)*x;a[4]=
(-f*E+i*B-j*A)*x;a[5]=(c*E-e*B+g*A)*x;a[6]=(-m*y+r*w-u*s)*x;a[7]=(k*y-n*w+o*s)*x;a[8]=(f*D-h*B+j*z)*x;a[9]=(-c*D+d*B-g*z)*x;a[10]=(m*q-p*w+u*v)*x;a[11]=(-k*q+l*w-o*v)*x;a[12]=(-f*C+h*A-i*z)*x;a[13]=(c*C-d*A+e*z)*x;a[14]=(-m*t+p*s-r*v)*x;a[15]=(k*t-l*s+n*v)*x;return a},toRotationMat:function(b,a){a||(a=mat4.create());a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];a[4]=b[4];a[5]=b[5];a[6]=b[6];a[7]=b[7];a[8]=b[8];a[9]=b[9];a[10]=b[10];a[11]=b[11];a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},toMat3:function(b,
a){a||(a=mat3.create());a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[4];a[4]=b[5];a[5]=b[6];a[6]=b[8];a[7]=b[9];a[8]=b[10];return a},toInverseMat3:function(b,a){var c=b[0],d=b[1],e=b[2],g=b[4],f=b[5],h=b[6],i=b[8],j=b[9],k=b[10],l=k*f-h*j,n=-k*g+h*i,o=j*g-f*i,m=c*l+d*n+e*o;if(!m)return null;m=1/m;a||(a=mat3.create());a[0]=l*m;a[1]=(-k*d+e*j)*m;a[2]=(h*d-e*f)*m;a[3]=n*m;a[4]=(k*c-e*i)*m;a[5]=(-h*c+e*g)*m;a[6]=o*m;a[7]=(-j*c+d*i)*m;a[8]=(f*c-d*g)*m;return a},multiply:function(b,a,c){c||(c=b);var d=b[0],e=b[1],
g=b[2],f=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],n=b[9],o=b[10],m=b[11],p=b[12],r=b[13],u=b[14],b=b[15],v=a[0],s=a[1],w=a[2],t=a[3],q=a[4],y=a[5],z=a[6],A=a[7],B=a[8],C=a[9],D=a[10],E=a[11],x=a[12],F=a[13],G=a[14],a=a[15];c[0]=v*d+s*h+w*l+t*p;c[1]=v*e+s*i+w*n+t*r;c[2]=v*g+s*j+w*o+t*u;c[3]=v*f+s*k+w*m+t*b;c[4]=q*d+y*h+z*l+A*p;c[5]=q*e+y*i+z*n+A*r;c[6]=q*g+y*j+z*o+A*u;c[7]=q*f+y*k+z*m+A*b;c[8]=B*d+C*h+D*l+E*p;c[9]=B*e+C*i+D*n+E*r;c[10]=B*g+C*j+D*o+E*u;c[11]=B*f+C*k+D*m+E*b;c[12]=x*d+F*h+G*l+a*p;c[13]=
x*e+F*i+G*n+a*r;c[14]=x*g+F*j+G*o+a*u;c[15]=x*f+F*k+G*m+a*b;return c},multiplyVec3:function(b,a,c){c||(c=a);var d=a[0],e=a[1],a=a[2];c[0]=b[0]*d+b[4]*e+b[8]*a+b[12];c[1]=b[1]*d+b[5]*e+b[9]*a+b[13];c[2]=b[2]*d+b[6]*e+b[10]*a+b[14];return c},multiplyVec4:function(b,a,c){c||(c=a);var d=a[0],e=a[1],g=a[2],a=a[3];c[0]=b[0]*d+b[4]*e+b[8]*g+b[12]*a;c[1]=b[1]*d+b[5]*e+b[9]*g+b[13]*a;c[2]=b[2]*d+b[6]*e+b[10]*g+b[14]*a;c[3]=b[3]*d+b[7]*e+b[11]*g+b[15]*a;return c},translate:function(b,a,c){var d=a[0],e=a[1],
a=a[2];if(!c||b==c)return b[12]=b[0]*d+b[4]*e+b[8]*a+b[12],b[13]=b[1]*d+b[5]*e+b[9]*a+b[13],b[14]=b[2]*d+b[6]*e+b[10]*a+b[14],b[15]=b[3]*d+b[7]*e+b[11]*a+b[15],b;var g=b[0],f=b[1],h=b[2],i=b[3],j=b[4],k=b[5],l=b[6],n=b[7],o=b[8],m=b[9],p=b[10],r=b[11];c[0]=g;c[1]=f;c[2]=h;c[3]=i;c[4]=j;c[5]=k;c[6]=l;c[7]=n;c[8]=o;c[9]=m;c[10]=p;c[11]=r;c[12]=g*d+j*e+o*a+b[12];c[13]=f*d+k*e+m*a+b[13];c[14]=h*d+l*e+p*a+b[14];c[15]=i*d+n*e+r*a+b[15];return c},scale:function(b,a,c){var d=a[0],e=a[1],a=a[2];if(!c||b==
c)return b[0]*=d,b[1]*=d,b[2]*=d,b[3]*=d,b[4]*=e,b[5]*=e,b[6]*=e,b[7]*=e,b[8]*=a,b[9]*=a,b[10]*=a,b[11]*=a,b;c[0]=b[0]*d;c[1]=b[1]*d;c[2]=b[2]*d;c[3]=b[3]*d;c[4]=b[4]*e;c[5]=b[5]*e;c[6]=b[6]*e;c[7]=b[7]*e;c[8]=b[8]*a;c[9]=b[9]*a;c[10]=b[10]*a;c[11]=b[11]*a;c[12]=b[12];c[13]=b[13];c[14]=b[14];c[15]=b[15];return c},rotate:function(b,a,c,d){var e=c[0],g=c[1],c=c[2],f=Math.sqrt(e*e+g*g+c*c);if(!f)return null;1!=f&&(f=1/f,e*=f,g*=f,c*=f);var h=Math.sin(a),i=Math.cos(a),j=1-i,a=b[0],f=b[1],k=b[2],l=b[3],
n=b[4],o=b[5],m=b[6],p=b[7],r=b[8],u=b[9],v=b[10],s=b[11],w=e*e*j+i,t=g*e*j+c*h,q=c*e*j-g*h,y=e*g*j-c*h,z=g*g*j+i,A=c*g*j+e*h,B=e*c*j+g*h,e=g*c*j-e*h,g=c*c*j+i;d?b!=d&&(d[12]=b[12],d[13]=b[13],d[14]=b[14],d[15]=b[15]):d=b;d[0]=a*w+n*t+r*q;d[1]=f*w+o*t+u*q;d[2]=k*w+m*t+v*q;d[3]=l*w+p*t+s*q;d[4]=a*y+n*z+r*A;d[5]=f*y+o*z+u*A;d[6]=k*y+m*z+v*A;d[7]=l*y+p*z+s*A;d[8]=a*B+n*e+r*g;d[9]=f*B+o*e+u*g;d[10]=k*B+m*e+v*g;d[11]=l*B+p*e+s*g;return d},rotateX:function(b,a,c){var d=Math.sin(a),a=Math.cos(a),e=b[4],
g=b[5],f=b[6],h=b[7],i=b[8],j=b[9],k=b[10],l=b[11];c?b!=c&&(c[0]=b[0],c[1]=b[1],c[2]=b[2],c[3]=b[3],c[12]=b[12],c[13]=b[13],c[14]=b[14],c[15]=b[15]):c=b;c[4]=e*a+i*d;c[5]=g*a+j*d;c[6]=f*a+k*d;c[7]=h*a+l*d;c[8]=e*-d+i*a;c[9]=g*-d+j*a;c[10]=f*-d+k*a;c[11]=h*-d+l*a;return c},rotateY:function(b,a,c){var d=Math.sin(a),a=Math.cos(a),e=b[0],g=b[1],f=b[2],h=b[3],i=b[8],j=b[9],k=b[10],l=b[11];c?b!=c&&(c[4]=b[4],c[5]=b[5],c[6]=b[6],c[7]=b[7],c[12]=b[12],c[13]=b[13],c[14]=b[14],c[15]=b[15]):c=b;c[0]=e*a+i*-d;
c[1]=g*a+j*-d;c[2]=f*a+k*-d;c[3]=h*a+l*-d;c[8]=e*d+i*a;c[9]=g*d+j*a;c[10]=f*d+k*a;c[11]=h*d+l*a;return c},rotateZ:function(b,a,c){var d=Math.sin(a),a=Math.cos(a),e=b[0],g=b[1],f=b[2],h=b[3],i=b[4],j=b[5],k=b[6],l=b[7];c?b!=c&&(c[8]=b[8],c[9]=b[9],c[10]=b[10],c[11]=b[11],c[12]=b[12],c[13]=b[13],c[14]=b[14],c[15]=b[15]):c=b;c[0]=e*a+i*d;c[1]=g*a+j*d;c[2]=f*a+k*d;c[3]=h*a+l*d;c[4]=e*-d+i*a;c[5]=g*-d+j*a;c[6]=f*-d+k*a;c[7]=h*-d+l*a;return c},frustum:function(b,a,c,d,e,g,f){f||(f=mat4.create());var h=
a-b,i=d-c,j=g-e;f[0]=2*e/h;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2*e/i;f[6]=0;f[7]=0;f[8]=(a+b)/h;f[9]=(d+c)/i;f[10]=-(g+e)/j;f[11]=-1;f[12]=0;f[13]=0;f[14]=-(2*g*e)/j;f[15]=0;return f},perspective:function(b,a,c,d,e){b=c*Math.tan(b*Math.PI/360);a*=b;return mat4.frustum(-a,a,-b,b,c,d,e)},ortho:function(b,a,c,d,e,g,f){f||(f=mat4.create());var h=a-b,i=d-c,j=g-e;f[0]=2/h;f[1]=0;f[2]=0;f[3]=0;f[4]=0;f[5]=2/i;f[6]=0;f[7]=0;f[8]=0;f[9]=0;f[10]=-2/j;f[11]=0;f[12]=-(b+a)/h;f[13]=-(d+c)/i;f[14]=-(g+e)/j;f[15]=
1;return f},lookAt:function(b,a,c,d){d||(d=mat4.create());var e=b[0],g=b[1],b=b[2],f=c[0],h=c[1],i=c[2],c=a[1],j=a[2];if(e==a[0]&&g==c&&b==j)return mat4.identity(d);var k,l,n,o,c=e-a[0],j=g-a[1],a=b-a[2];o=1/Math.sqrt(c*c+j*j+a*a);c*=o;j*=o;a*=o;k=h*a-i*j;i=i*c-f*a;f=f*j-h*c;(o=Math.sqrt(k*k+i*i+f*f))?(o=1/o,k*=o,i*=o,f*=o):f=i=k=0;h=j*f-a*i;l=a*k-c*f;n=c*i-j*k;(o=Math.sqrt(h*h+l*l+n*n))?(o=1/o,h*=o,l*=o,n*=o):n=l=h=0;d[0]=k;d[1]=h;d[2]=c;d[3]=0;d[4]=i;d[5]=l;d[6]=j;d[7]=0;d[8]=f;d[9]=n;d[10]=a;d[11]=
0;d[12]=-(k*e+i*g+f*b);d[13]=-(h*e+l*g+n*b);d[14]=-(c*e+j*g+a*b);d[15]=1;return d},str:function(b){return"["+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+", "+b[4]+", "+b[5]+", "+b[6]+", "+b[7]+", "+b[8]+", "+b[9]+", "+b[10]+", "+b[11]+", "+b[12]+", "+b[13]+", "+b[14]+", "+b[15]+"]"}},quat4={create:function(b){var a=new glMatrixArrayType(4);b&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3]);return a},set:function(b,a){a[0]=b[0];a[1]=b[1];a[2]=b[2];a[3]=b[3];return a},calculateW:function(b,a){var c=b[0],d=b[1],e=
b[2];if(!a||b==a)return b[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),b;a[0]=c;a[1]=d;a[2]=e;a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e));return a},inverse:function(b,a){if(!a||b==a)return b[0]*=-1,b[1]*=-1,b[2]*=-1,b;a[0]=-b[0];a[1]=-b[1];a[2]=-b[2];a[3]=b[3];return a},length:function(b){var a=b[0],c=b[1],d=b[2],b=b[3];return Math.sqrt(a*a+c*c+d*d+b*b)},normalize:function(b,a){a||(a=b);var c=b[0],d=b[1],e=b[2],g=b[3],f=Math.sqrt(c*c+d*d+e*e+g*g);if(0==f)return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a;f=1/f;a[0]=c*f;
a[1]=d*f;a[2]=e*f;a[3]=g*f;return a},multiply:function(b,a,c){c||(c=b);var d=b[0],e=b[1],g=b[2],b=b[3],f=a[0],h=a[1],i=a[2],a=a[3];c[0]=d*a+b*f+e*i-g*h;c[1]=e*a+b*h+g*f-d*i;c[2]=g*a+b*i+d*h-e*f;c[3]=b*a-d*f-e*h-g*i;return c},multiplyVec3:function(b,a,c){c||(c=a);var d=a[0],e=a[1],g=a[2],a=b[0],f=b[1],h=b[2],b=b[3],i=b*d+f*g-h*e,j=b*e+h*d-a*g,k=b*g+a*e-f*d,d=-a*d-f*e-h*g;c[0]=i*b+d*-a+j*-h-k*-f;c[1]=j*b+d*-f+k*-a-i*-h;c[2]=k*b+d*-h+i*-f-j*-a;return c},toMat3:function(b,a){a||(a=mat3.create());var c=
b[0],d=b[1],e=b[2],g=b[3],f=c+c,h=d+d,i=e+e,j=c*f,k=c*h,c=c*i,l=d*h,d=d*i,e=e*i,f=g*f,h=g*h,g=g*i;a[0]=1-(l+e);a[1]=k-g;a[2]=c+h;a[3]=k+g;a[4]=1-(j+e);a[5]=d-f;a[6]=c-h;a[7]=d+f;a[8]=1-(j+l);return a},toMat4:function(b,a){a||(a=mat4.create());var c=b[0],d=b[1],e=b[2],g=b[3],f=c+c,h=d+d,i=e+e,j=c*f,k=c*h,c=c*i,l=d*h,d=d*i,e=e*i,f=g*f,h=g*h,g=g*i;a[0]=1-(l+e);a[1]=k-g;a[2]=c+h;a[3]=0;a[4]=k+g;a[5]=1-(j+e);a[6]=d-f;a[7]=0;a[8]=c-h;a[9]=d+f;a[10]=1-(j+l);a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return a},
slerp:function(b,a,c,d){d||(d=b);var e=b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3];if(1<=Math.abs(e))return d!=b&&(d[0]=b[0],d[1]=b[1],d[2]=b[2],d[3]=b[3]),d;var g=Math.acos(e),f=Math.sqrt(1-e*e);if(0.0010>Math.abs(f))return d[0]=0.5*b[0]+0.5*a[0],d[1]=0.5*b[1]+0.5*a[1],d[2]=0.5*b[2]+0.5*a[2],d[3]=0.5*b[3]+0.5*a[3],d;e=Math.sin((1-c)*g)/f;c=Math.sin(c*g)/f;d[0]=b[0]*e+a[0]*c;d[1]=b[1]*e+a[1]*c;d[2]=b[2]*e+a[2]*c;d[3]=b[3]*e+a[3]*c;return d},str:function(b){return"["+b[0]+", "+b[1]+", "+b[2]+", "+b[3]+
"]"}};(function(b){function a(a){return{get:function(){return this._data[a]},set:function(b){this._data[a]=b;this._callback&&this._callback(this)},configurable:!1,enumerable:!1}}if(!b){var c=function(a,b,c,f){this._data=new Float32Array(3);"object"==typeof a&&a._data?(this._data[0]=a._data[0],this._data[1]=a._data[1],this._data[2]=a._data[2]):(this._data[0]=a||0,this._data[1]=b||0,this._data[2]=c||0);this._callback="function"==typeof f?f:0},b=c.prototype;Object.defineProperty(b,"x",a(0));Object.defineProperty(b,
"y",a(1));Object.defineProperty(b,"z",a(2));b.toString=function(){return"[object XML3DVec3]"};b.add=function(a){return a._data?new c(this._data[0]+a._data[0],this._data[1]+a._data[1],this._data[2]+a._data[2]):new c(this._data[0]+a.x,this._data[1]+a.y,this._data[2]+a.z)};b.subtract=function(a){return a._data?new c(this._data[0]-a._data[0],this._data[1]-a._data[1],this._data[2]-a._data[2]):new c(this._data[0]-a.x,this._data[1]-a.y,this._data[2]-a.z)};b.length=function(){return Math.sqrt(this._data[0]*
this._data[0]+this._data[1]*this._data[1]+this._data[2]*this._data[2])};b.setVec3Value=function(a){a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a);if(!a)throw Error("Wrong format for XML3DVec3::setVec3Value");this._data[0]=+a[1];this._data[1]=+a[2];this._data[2]=+a[3];this._callback&&this._callback(this)};b.set=function(a,b,c){1==arguments.length?(this._data[0]=a._data[0],this._data[1]=a._data[1],this._data[2]=a._data[2]):3==arguments.length&&(this._data[0]=a,this._data[1]=b,this._data[2]=c);this._callback&&
this._callback(this)};b.multiply=function(a){return a._data?new c(this._data[0]*a._data[0],this._data[1]*a._data[1],this._data[2]*a._data[2]):new c(this._data[0]*a.x,this._data[1]*a.y,this._data[2]*a.z)};b.scale=function(a){return new c(this._data[0]*a,this._data[1]*a,this._data[2]*a)};b.cross=function(a){return a._data?new c(this._data[1]*a._data[2]-this._data[2]*a._data[1],this._data[2]*a._data[0]-this._data[0]*a._data[2],this._data[0]*a._data[1]-this._data[1]*a._data[0]):new c(this._data[1]*a.z-
this._data[2]*a.y,this._data[2]*a.x-this._data[0]*a.z,this._data[0]*a.y-this._data[1]*a.x)};b.negate=function(){return new c(-this._data[0],-this._data[1],-this._data[2])};b.dot=function(a){return this._data[0]*a.x+this._data[1]*a.y+this._data[2]*a.z};b.normalize=function(){var a=this.length();if(a)a=1/a;else throw Error();return new c(this._data[0]*a,this._data[1]*a,this._data[2]*a)};XML3D.XML3DVec3=c;window.XML3DVec3=c}})(XML3D._native);(function(b){if(!b){var a=function(b,d,e){var g=this;this._data=new Float32Array(4);this._callback="function"==typeof e?e:0;e=function(){g._updateQuaternion();g._callback&&g._callback(g)};b instanceof a?(this._axis=new window.XML3DVec3(0,0,1,e),this._angle=0,this.setAxisAngle(b.axis,b.angle)):(this._axis=b?new window.XML3DVec3(b.x,b.y,b.z,e):new window.XML3DVec3(0,0,1,e),this._angle=d||0,this._updateQuaternion())},b=a.prototype;Object.defineProperty(b,"axis",{get:function(){return this._axis},set:function(){throw Error("Can't set axis. XML3DRotation::axis is readonly.");
},configurable:!1,enumerable:!1});Object.defineProperty(b,"angle",{get:function(){return this._angle},set:function(a){this._angle=a;this._updateQuaternion();this._callback&&this._callback(this)},configurable:!1,enumerable:!1});b.toString=function(){return"[object XML3DRotation]"};b.setAxisAngle=function(a,b){if("object"!=typeof a||isNaN(b))throw Error("Illegal axis and/or angle values: ( axis="+a+" angle="+b+" )");this._axis._data[0]=a._data[0];this._axis._data[1]=a._data[1];this._axis._data[2]=a._data[2];
this._angle=b;this._updateQuaternion();this._callback&&this._callback(this)};b.setRotation=function(a,b){var e=a.normalize(),g=b.normalize(),f=e.cross(g);f.length()||(f=Math.abs(e._data[1])>=0.9*Math.abs(e._data[0])&&Math.abs(e._data[2])>=0.9*Math.abs(e._data[0])?new window.XML3DVec3(0,-e._data[2],e._data[1]):Math.abs(e._data[0])>=0.9*Math.abs(e._data[1])&&Math.abs(e._data[2])>=0.9*Math.abs(e._data[1])?new window.XML3DVec3(-e._data[2],0,e._data[0]):new window.XML3DVec3(-e._data[1],e._data[0],0));
this.setAxisAngle(f,Math.acos(e.dot(g)))};b._updateQuaternion=function(){var a=this._axis.length();1.0E-5<a?(a=Math.sin(this._angle/2)/a,this._data[0]=this._axis.x*a,this._data[1]=this._axis.y*a,this._data[2]=this._axis.z*a,this._data[3]=Math.cos(this._angle/2)):quat4.set([0,0,0,1],this._data)};b.setAxisAngleValue=function(a){var b=/^\s*(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a);if(!b)throw Error("Could not parse AxisAngle string: "+a);this.setAxisAngle(new window.XML3DVec3(+b[1],+b[2],+b[3]),+b[4])};
b.interpolate=function(b,d){var e=quat4.create(),g=new a;quat4.slerp(this._data,b._data,d,e);g._setQuaternion(e);return g};b.setQuaternion=function(a,b){this._setQuaternion([a.x,a.y,a.z,b])};b.set=function(a){this.setAxisAngle(a.axis,a.angle)};b.toMatrix=function(){var a=quat4.create(this._data);a[3]=-a[3];var b=new window.XML3DMatrix;quat4.toMat4(a,b._data);return b};b.rotateVec3=function(a){vec3.create();var b=new window.XML3DVec3;quat4.multiplyVec3(this._data,a._data,b._data);return b};b._setQuaternion=
function(a){var b=Math.sqrt(1-a[3]*a[3]);0.0010>b||isNaN(b)?(this._axis._data[0]=0,this._axis._data[1]=0,this._axis._data[2]=1,this._angle=0):(b=1/b,this._axis._data[0]=a[0]*b,this._axis._data[1]=a[1]*b,this._axis._data[2]=a[2]*b,this._angle=2*Math.acos(a[3]));this._data=quat4.create(a);this._callback&&this._callback(this)};b.multiply=function(b){var d=new a,e=quat4.create();quat4.multiply(this._data,b._data,e);d._setQuaternion(e);return d};b.normalize=function(){var b=this._axis.normalize();return new a(b,
this._angle)};XML3D.XML3DRotation=a;window.XML3DRotation=a}})(XML3D._native);(function(b){b||(b=function(a,b,d){var e=this,g=function(){e._callback&&e._callback(e)};this._min=new window.XML3DVec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,g);this._max=new window.XML3DVec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE,g);a&&a.min?(this._min.set(a.min),this._max.set(a.max)):(a&&this._min.set(a),b&&this._max.set(b));this._callback="function"==typeof d?d:0},Object.defineProperty(b.prototype,"min",{get:function(){return this._min},set:function(){throw Error("XML3DBox::min is readonly.");
},configurable:!1,enumerable:!1}),Object.defineProperty(b.prototype,"max",{get:function(){return this._max},set:function(){throw Error("XML3DBox::max is readonly.");},configurable:!1,enumerable:!1}),b.prototype.size=function(){var a=this._max.subtract(this._min);0>a.x&&(a.x=0);0>a.y&&(a.y=0);0>a.z&&(a.z=0);return a},b.prototype.center=function(){return this._min.add(this._max).scale(0.5)},b.prototype.makeEmpty=function(){this._min=new window.XML3DVec3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);
this._max=new window.XML3DVec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);this._callback&&this._callback(this)},b.prototype.isEmpty=function(){return this._min.x>this._max.x||this._min.y>this._max.y||this._min.z>this._max.z},b.prototype.toString=function(){return"[object XML3DBox]"},b.prototype.set=function(a){this._min.set(a.min);this._max.set(a.max);this._callback&&this._callback(this)},b.prototype.extend=function(a){var b;if(a.constructor===window.XML3DBox)b=a.min,a=a.max;else if(a.constructor===
window.XML3DVec3)b=a;else return;b.x<this._min.x&&(this._min.x=b.x);b.y<this._min.y&&(this._min.y=b.y);b.z<this._min.z&&(this._min.z=b.z);a.x>this._max.x&&(this._max.x=a.x);a.y>this._max.y&&(this._max.y=a.y);a.z>this._max.z&&(this._max.z=a.z)},XML3D.XML3DBox=b,window.XML3DBox=b)})(XML3D._native);(function(b){function a(a){return{get:function(){return this._data[a]},set:function(b){this._data[a]=b;this._callback&&this._callback(this)},configurable:!1,enumerable:!1}}if(!b){var c=function(a,b,c,f,h,i,j,k,l,n,o,m,p,r,u,v,s){"number"==typeof a&&16<=arguments.length?(this._data=new Float32Array(arguments),this._callback="function"==typeof s?s:0):"object"==typeof a&&1==arguments.length?this._data=new Float32Array(a._data):(this._data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this._callback=
"function"==typeof a?a:0)},b=c.prototype;Object.defineProperty(b,"m11",a(0));Object.defineProperty(b,"m12",a(1));Object.defineProperty(b,"m13",a(2));Object.defineProperty(b,"m14",a(3));Object.defineProperty(b,"m21",a(4));Object.defineProperty(b,"m22",a(5));Object.defineProperty(b,"m23",a(6));Object.defineProperty(b,"m24",a(7));Object.defineProperty(b,"m31",a(8));Object.defineProperty(b,"m32",a(9));Object.defineProperty(b,"m33",a(10));Object.defineProperty(b,"m34",a(11));Object.defineProperty(b,"m41",
a(12));Object.defineProperty(b,"m42",a(13));Object.defineProperty(b,"m43",a(14));Object.defineProperty(b,"m44",a(15));b.toString=function(){return"[object XML3DMatrix]"};b.setMatrixValue=function(a){a=/^(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s+(\S+)$/.exec(a);if(!a)throw{code:DOMException.SYNTAX_ERR,message:"SYNTAX_ERR: DOM Exception 12"};if(17!=a.length)throw{code:DOMException.SYNTAX_ERR,message:"Illegal number of elements: "+
(a.length-1)+"expected: 16"};this._data=new Float32Array(a.slice(1));this._callback&&this._callback(this)};b.multiply=function(a){var b=new c;mat4.multiply(this._data,a._data,b._data);return b};b.inverse=function(){var a=new c;mat4.inverse(this._data,a._data);if(isNaN(a._data[0]))throw Error("Trying to invert matrix that is not invertable.");return a};b.rotate=function(a,b,g){var f=new c;if(void 0===b&&void 0===g)return mat4.rotateZ(this._data,a,f._data),f;mat4.rotateZ(this._data,g,f._data);mat4.rotateY(f._data,
b);mat4.rotateX(f._data,a);return f};b.rotateAxisAngle=function(a,b,g,f){var h=new c;mat4.rotate(this._data,f,[a,b,g],h._data);return h};b.scale=function(a,b,g){var f=new c;g||(g=1);b||(b=a);mat4.scale(this._data,[a,b,g],f._data);return f};b.translate=function(a,b,g){var f=new c;mat4.translate(this._data,[a,b,g],f._data);return f};XML3D.XML3DMatrix=c;window.XML3DMatrix||(window.XML3DMatrix=c)}})(XML3D._native);(function(b){if(!b){var b=function(a,b,e){var g=this,f=function(){g._callback&&g._callback(g)};this._origin=new window.XML3DVec3(0,0,0,f);this._direction=new window.XML3DVec3(0,0,-1,f);a&&a.origin?this.set(a,b):(a&&this._origin.set(a),b&&this._direction.set(b));this._callback="function"==typeof e?e:0},a=b.prototype;Object.defineProperty(a,"origin",{get:function(){return this._origin},set:function(){throw Error("Can't set axis. XML3DRay::origin is readonly.");},configurable:!1,enumerable:!1});Object.defineProperty(a,
"direction",{get:function(){return this._direction},set:function(){throw Error("Can't set axis. XML3DRay::origin is readonly.");},configurable:!1,enumerable:!1});a.set=function(a){this._origin.set(a.origin);this._direction.set(a.direction);this._callback&&this._callback(this)};a.toString=function(){return"[object XML3DRay]"};XML3D.XML3DRay=b;window.XML3DRay=b}})(XML3D._native);XML3D.data=XML3D.data||{};XML3D.data.Adapter=function(b,a){this.factory=b;this.node=a};XML3D.data.Adapter.prototype.init=function(){};XML3D.data.Adapter.prototype.notifyChanged=function(){};XML3D.data.Adapter.prototype.isAdapterFor=function(){return!1};XML3D.data.AdapterFactory=function(){};
XML3D.data.AdapterFactory.prototype.getAdapter=function(b,a){if(!b||void 0===b._configured)return null;var c=b._configured,d=a||this.name,e=c.adapters[d];if(void 0!==e)return e;if(e=this.createAdapter(b))c.adapters[d]=e,e.init();return e};XML3D.data.AdapterFactory.prototype.createAdapter=function(){return null};(function(){var b={NODE_INSERTED:0,VALUE_MODIFIED:1,NODE_REMOVED:2,DANGLING_REFERENCE:3,VALID_REFERENCE:4,THIS_REMOVED:5,Notification:function(a){this.type=a}};b.Notification.prototype.toString=function(){return"Notification (type:"+this.type+")"};b.NotificationWrapper=function(a,b){this.wrapped=a;this.type=b};b.NotificationWrapper.prototype.toString=function(){return"NotificationWrapper (type:"+this.type+", wrapped: "+this.wrapped+")"};b.ReferenceNotification=function(a,c,d){this.relatedNode=a;this.attrName=
c;this.value=null;"string"==typeof d&&(d=new XML3D.URI(d));d&&d.valid?"urn"==d.scheme?this.type=b.VALID_REFERENCE:(this.value=XML3D.URIResolver.resolve(d),XML3D.debug.logDebug("Resolved node: #"+d.fragment),this.type=this.value?b.VALID_REFERENCE:b.DANGLING_REFERENCE):this.type=b.DANGLING_REFERENCE};b.ReferenceNotification.prototype.toString=function(){return"ReferenceNotification (type:"+this.type+", value: "+this.value+")"};XML3D.createClass(b.NotificationWrapper,b.Notification);XML3D.events=XML3D.events||
{};XML3D.extend(XML3D.events,b)})();XML3D.config=XML3D.config||{};XML3D.config.isXML3DElement=function(b){return b.nodeType===Node.ELEMENT_NODE&&b.namespaceURI==XML3D.xml3dNS};
XML3D.config.element=function(b,a){if(void 0===b._configured&&XML3D.config.isXML3DElement(b)){var c=XML3D.classInfo[b.localName];if(void 0===c)XML3D.debug.logInfo("Unrecognised element "+b.localName);else{b._configured="xml3d"==b.localName?new XML3D.XML3DHandler(b):new XML3D.ElementHandler(b,a);b._configured.registerAttributes(c);void 0==b.style&&(b.style=null);for(c=b.firstElementChild;c;)XML3D.config.element(c),c=c.nextElementSibling;return c}}};
XML3D.config.configure=function(b,a){Array.isArray(b)&&Array.forEach(b,XML3D.config.element);XML3D.config.element(b,a)};(function(b){if(!b){var b={},a=document.getElementById;b.getElementById=function(b){var c=a.call(this,b);if(c)return c;for(var c=this.getElementsByTagName("*"),g=0;g<c.length;g++){var f=c[g];if(f.getAttribute("id")===b)return f}return null};var c=document.createElementNS;b.createElementNS=function(a,b){var g=c.call(this,a,b);a==XML3D.xml3dNS&&XML3D.config.element(g,!0);return g};XML3D.extend(window.document,b)}})(XML3D._native);
if(-1!=navigator.userAgent.indexOf("WebKit")){var attrModifiedWorks=!1,listener=function(){attrModifiedWorks=!0};document.documentElement.addEventListener("DOMAttrModified",listener,!1);document.documentElement.setAttribute("___TEST___",!0);document.documentElement.removeAttribute("___TEST___",!0);document.documentElement.removeEventListener("DOMAttrModified",listener,!1);attrModifiedWorks||(Element.prototype.__setAttribute=HTMLElement.prototype.setAttribute,Element.prototype.setAttribute=function(b,
a){var c=this.getAttribute(b);this.__setAttribute(b,a);var a=this.getAttribute(b),d=document.createEvent("MutationEvent");d.initMutationEvent("DOMAttrModified",!0,!1,this,c||"",a||"",b,null==c?d.ADDITION:d.MODIFICATION);this.dispatchEvent(d)},Element.prototype.__removeAttribute=HTMLElement.prototype.removeAttribute,Element.prototype.removeAttribute=function(b){var a=this.getAttribute(b);this.__removeAttribute(b);var c=document.createEvent("MutationEvent");c.initMutationEvent("DOMAttrModified",!0,
!1,this,a,"",b,c.REMOVAL);this.dispatchEvent(c)})};(function(){function b(a){var b=a.target._configured,c=b&&b.handlers[a.attrName];if(c){var d=!1;c.setFromAttribute&&(d=c.setFromAttribute(a.newValue));d||(a=new f.NotificationWrapper(a),a.type=f.VALUE_MODIFIED,b.notify(a))}}function a(a){var b=a.target,d=a.relatedNode._configured;d&&(a=new f.NotificationWrapper(a),b.nodeType==Node.TEXT_NODE&&d.handlers.value?(a.type=f.VALUE_MODIFIED,d.handlers.value.resetValue()):(a.type=f.NODE_REMOVED,d.notify(a),b._configured&&(a.type=f.THIS_REMOVED,c(b,a))))}function c(a,
b){a._configured&&(a._configured.notify(b),a._configured.remove(b));for(var d=a.firstElementChild;d;)c(d,b),d=d.nextElementSibling}function d(a){var b=a.target,c=a.relatedNode._configured;c&&a.currentTarget!==b&&(a=new f.NotificationWrapper(a),b.nodeType==Node.TEXT_NODE&&c.handlers.value?(a.type=f.VALUE_MODIFIED,c.handlers.value.resetValue()):(XML3D.config.element(b),a.type=f.NODE_INSERTED),c.notify(a))}function e(a,b,c){Object.defineProperty(b,a,{get:function(){return c[a]}})}var g={},f=XML3D.events;
g.ElementHandler=function(c,e){c&&(this.element=c,this.handlers={},this.adapters={},e&&(c.addEventListener("DOMNodeRemoved",a,!0),c.addEventListener("DOMNodeInserted",d,!0),c.addEventListener("DOMAttrModified",b,!1),this.monitoring=!0))};g.ElementHandler.prototype.registerAttributes=function(a){var b=this.element,c;for(c in a)if(void 0===a[c])delete b[c];else if(void 0!==a[c].a){var d=a[c].id||c,e=new a[c].a(b,d,a[c].params);this.handlers[d]=e;Object.defineProperty(b,c,e.desc)}else void 0!==a[c].m?
b[c]=a[c].m:XML3D.debug.logError("Can't configure "+b.nodeName+"::"+c);return b};g.ElementHandler.prototype.registerMixed=function(){this.element.addEventListener("DOMCharacterDataModified",this,!1)};g.ElementHandler.prototype.handleEvent=function(a){XML3D.debug.logDebug(a.type+" at "+a.currentTarget.localName+"/"+a.target);var b=new f.NotificationWrapper(a);switch(a.type){case "DOMCharacterDataModified":b.type=f.VALUE_MODIFIED,this.handlers.value.resetValue(),this.notify(b)}};g.ElementHandler.prototype.notify=
function(a){var b=this.adapters,c;for(c in b)try{b[c].notifyChanged(a)}catch(d){XML3D.debug.logError(d)}};g.ElementHandler.prototype.addOpposite=function(a){(this.opposites||(this.opposites=[])).push(a)};g.ElementHandler.prototype.removeOpposite=function(a){for(var b in this.opposites)if(this.opposites[b].relatedNode===a.relatedNode){this.opposites.splice(b,1);break}};g.ElementHandler.prototype.notifyOpposite=function(a){a.value&&a.value._configured&&a.value._configured.addOpposite(a)};g.ElementHandler.prototype.remove=
function(){if(this.opposites)for(var a in this.opposites){var b=this.opposites[a];if(b.relatedNode._configured){var c=new f.ReferenceNotification(b.relatedNode,b.attrName);b.relatedNode._configured.notify(c)}}for(var d in this.handlers)a=this.handlers[d],a.remove&&a.remove()};g.ElementHandler.prototype.resolve=function(a){a=new XML3D.URI(this.element[a]);return a.valid&&a.fragment?XML3D.URIResolver.resolve(a):null};g.ElementHandler.prototype.toString=function(){return"ElementHandler ("+this.element.nodeName+
", id: "+this.element.id+")"};var h="clientHeight,clientLeft,clientTop,clientWidth,offsetHeight,offsetLeft,offsetTop,offsetWidth".split(",");g.XML3DHandler=function(a){g.ElementHandler.call(this,a,!0);var b=document.createElement("canvas");b.width=800;b.height=600;this.canvas=b;for(var c in h)e(h[c],a,b);a.getBoundingClientRect=function(){return b.getBoundingClientRect()}};XML3D.createClass(g.XML3DHandler,g.ElementHandler);XML3D.extend(XML3D,g)})();(function(){var b=function(a){switch(a.toLowerCase()){case "true":case "1":return!0;case "false":case "0":return!1;default:return Boolean(a)}},a={},c=XML3D.events,d=function(){this.setter=function(){}};a.StringAttributeHandler=function(a,b){this.desc={get:function(){return this.getAttribute(b)||""},set:function(a){this.setAttribute(b,a)}}};a.ReferenceHandler=function(a,b){this.setFromAttribute=function(d){d=new c.ReferenceNotification(a,b,d);a._configured.notify(d);a._configured.notifyOpposite(d);
return!0};this.remove=function(){var d=new c.ReferenceNotification(a,b,a.getAttribute(b));d.type==c.VALID_REFERENCE&&d.value._configured&&d.value._configured.removeOpposite(d)};this.desc={get:function(){return this.getAttribute(b)||""},set:function(a){this.setAttribute(b,a)}};a._configured.notifyOpposite(new c.ReferenceNotification(a,b,a.getAttribute(b)))};a.EnumAttributeHandler=function(a,b,c){d.call(this,a);var e=c.d;this.setFromAttribute=function(a){e=(a=a.toLowerCase())&&void 0!==c.e[a]?c.e[a]:
c.d;return!1};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b));this.desc={get:function(){return c.e[e]},set:function(a){this.setAttribute(b,a);e=(a="string"==typeof a?a.toLowerCase():void 0)&&void 0!==c.e[a]?c.e[a]:c.d}}};a.EnumAttributeHandler.prototype=new d;a.EnumAttributeHandler.prototype.constructor=a.EnumAttributeHandler;a.EventAttributeHandler=function(a,b){d.call(this,a);var c=null;this.setFromAttribute=function(){c=null;return!1};this.desc={get:function(){return c?c:!this.hasAttribute(b)||
void 0===c?null:eval("c = function onclick(event){\n  "+this.getAttribute(b)+"\n}")},set:function(d){c="function"==typeof d?d:void 0;this._configured.notify({attrName:b,relatedNode:a})}}};a.EventAttributeHandler.prototype=new d;a.EventAttributeHandler.prototype.constructor=a.EventAttributeHandler;a.IntAttributeHandler=function(a,b,c){var d=c;this.setFromAttribute=function(e){d=(e=e.match(/^\d+/))?+e[0]:c;a._configured.canvas&&(a._configured.canvas[b]=d);return!1};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b));
this.desc={get:function(){return d},set:function(a){a=+a;d=isNaN(a)?c:Math.floor(a);this.setAttribute(b,d+"")}}};a.IntAttributeHandler.prototype=new d;a.IntAttributeHandler.prototype.constructor=a.IntAttributeHandler;a.FloatAttributeHandler=function(a,b,c){var d=c;this.setFromAttribute=function(a){a=+a;d=isNaN(a)?c:a;return!1};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b));this.desc={get:function(){return d},set:function(a){a=+a;d=isNaN(a)?c:a;this.setAttribute(b,d+"")}}};a.BoolAttributeHandler=
function(a,c,d){var e=d;this.setFromAttribute=function(a){e=b(a+"");return!1};a.hasAttribute(c)&&this.setFromAttribute(a.getAttribute(c));this.desc={get:function(){return e},set:function(a){e=Boolean(a);this.setAttribute(c,e+"")}}};a.XML3DVec3AttributeHandler=function(a,b,c){var d=null,e=this,g=function(c){a.setAttribute(b,c.x+" "+c.y+" "+c.z)};this.setFromAttribute=function(a){d||(d=new window.XML3DVec3(0,0,0,g));(a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a))?(d._data[0]=a[1],d._data[1]=a[2],d._data[2]=
a[3]):d._data.set(c);return!1};this.desc={get:function(){d||(this.hasAttribute(b)?e.setFromAttribute(this.getAttribute(b)):d=new window.XML3DVec3(c[0],c[1],c[2],g));return d},set:function(){throw Error("Can't set "+a.nodeName+"::"+b+": it's readonly");}}};a.XML3DRotationAttributeHandler=function(a,b,c){var d=null,e=this,g=function(c){a.setAttribute(b,c.axis.x+" "+c.axis.y+" "+c.axis.z+" "+c.angle)};this.setFromAttribute=function(a){d||(d=new window.XML3DRotation(null,null,g));(a=/^\s*(\S+)\s+(\S+)\s+(\S+)\s+(\S+)\s*$/.exec(a))?
(d._axis._data[0]=+a[1],d._axis._data[1]=+a[2],d._axis._data[2]=+a[3],d._angle=+a[4]):(d._axis._data[0]=c[0],d._axis._data[1]=c[1],d._axis._data[2]=c[2],d._angle=c[3]);d._updateQuaternion();return!1};this.desc={get:function(){d||(this.hasAttribute(b)?e.setFromAttribute(this.getAttribute(b)):d=new window.XML3DRotation(new window.XML3DVec3(c[0],c[1],c[2]),c[3],g));return d},set:function(){throw Error("Can't set "+a.nodeName+"::"+b+": it's readonly");}}};var e=function(a,b,c){a._configured.registerMixed();
return{get:function(){b.value||(b.value=c.parse(a));return b.value},set:function(){throw Error("Can't set "+a.nodeName+"::value: it's readonly");}}},g=function(a){for(var b="",a=a.firstChild;a;)b+=3==a.nodeType?a.textContent:" ",a=a.nextSibling;return b};a.FloatArrayValueHandler=function(a){var b={};this.desc=e(a,b,this);this.resetValue=function(){b.value=null}};a.FloatArrayValueHandler.prototype.parse=function(a){return(a=g(a).match(/([+\-0-9eE\.]+)/g))?new Float32Array(a):new Float32Array};a.Float2ArrayValueHandler=
a.FloatArrayValueHandler;a.Float3ArrayValueHandler=a.FloatArrayValueHandler;a.Float4ArrayValueHandler=a.FloatArrayValueHandler;a.Float4x4ArrayValueHandler=a.FloatArrayValueHandler;a.IntArrayValueHandler=function(a){var b={};this.desc=e(a,b,this);this.resetValue=function(){b.value=null}};a.IntArrayValueHandler.prototype.parse=function(a){return(a=g(a).match(/([+\-0-9]+)/g))?new Int32Array(a):new Int32Array};a.BoolArrayValueHandler=function(a){var b={};this.desc=e(a,b,this);this.resetValue=function(){b.value=
null}};a.BoolArrayValueHandler.prototype.parse=function(a){a=g(a).match(/(true|false|0|1)/ig);return!a?new Uint8Array:(a=Array.map(a,b))?new Uint8Array(a):new Uint8Array};a.CanvasStyleHandler=function(a,b){var c=a._configured.canvas;this.desc={};this.desc.get=function(){return c.style};this.desc.set=function(){};this.setFromAttribute=function(a){c.setAttribute(b,a)};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b))};a.CanvasClassHandler=function(a,b){var c=a._configured.canvas;c.className=
"_xml3d";this.desc={};this.desc.get=function(){return c.className};this.desc.set=function(a){c.className=a};this.setFromAttribute=function(a){c.setAttribute(b,a+" _xml3d")};a.hasAttribute(b)&&this.setFromAttribute(a.getAttribute(b))};XML3D.extend(XML3D,a)})();XML3D.methods=XML3D.methods||{};
new function(){var b={xml3dCreateXML3DVec3:function(){return new window.XML3DVec3},xml3dCreateXML3DRay:function(){return new window.XML3DRay},xml3dGetElementByRay:function(){XML3D.debug.logError(this.nodeName+"::getElementByRay is not implemeted yet.");return null},xml3dCreateXML3DMatrix:function(){return new window.XML3DMatrix},xml3dCreateXML3DRotation:function(){return new window.XML3DRotation},viewGetDirection:function(){return this.orientation.rotateVec3(new window.XML3DVec3(0,0,-1))},viewSetPosition:function(a){this.position=
a}},a=vec3.create(),c=vec3.create(),d=vec3.create();quat4.setFromMat3=function(a,b){var c=a[0]+a[4]+a[8];0<c?(c=2*Math.sqrt(c+1),b[0]=(a[7]-a[5])/c,b[1]=(a[2]-a[6])/c,b[2]=(a[3]-a[1])/c,b[3]=0.25*c):a[0]>a[4]&a[0]>a[8]?(c=2*Math.sqrt(1+a[0]-a[4]-a[8]),b[3]=(a[7]-a[5])/c,b[0]=0.25*c,b[1]=(a[1]+a[3])/c,b[2]=(a[2]+a[6])/c):a[4]>a[8]?(c=2*Math.sqrt(1+a[4]-a[0]-a[8]),b[3]=(a[2]-a[6])/c,b[0]=(a[1]+a[3])/c,b[1]=0.25*c,b[2]=(a[5]+a[7])/c):(c=2*Math.sqrt(1+a[8]-a[0]-a[4]),b[3]=(a[3]-a[1])/c,b[0]=(a[2]+a[6])/
c,b[1]=(a[5]+a[7])/c,b[2]=0.25*c)};quat4.setFromBasis=function(a,b,c,d){var i=1/vec3.length(a),j=1/vec3.length(b),k=1/vec3.length(c),l=mat3.create();l[0]=a[0]*i;l[1]=b[0]*j;l[2]=c[0]*k;l[3]=a[1]*i;l[4]=b[1]*j;l[5]=c[1]*k;l[6]=a[2]*i;l[7]=b[2]*j;l[8]=c[2]*k;quat4.setFromMat3(l,d)};b.viewSetDirection=function(b){var b=b||new window.XML3DVec3(0,0,-1),b=b.normalize(),g=this.orientation.rotateVec3(new window.XML3DVec3(0,1,0)),g=g.normalize();vec3.cross(b._data,g._data,a);vec3.length(a)||(a=this.orientation.rotateVec3(new window.XML3DVec3(1,
0,0))._data);vec3.cross(a,b._data,c);vec3.negate(b._data,d);b=quat4.create();quat4.setFromBasis(a,c,d,b);this.orientation._setQuaternion(b)};b.viewSetUpVector=function(a){var a=a||new window.XML3DVec3(0,1,0),a=a.normalize(),b=new window.XML3DRotation;b.setRotation(new window.XML3DVec3(0,1,0),a);b=this.orientation.multiply(b);b=b.normalize();this.orientation.set(b)};b.viewGetUpVector=function(){return this.orientation.rotateVec3(new window.XML3DVec3(0,1,0))};b.viewLookAt=function(a){this.setDirection(a.subtract(this.position))};
b.viewGetViewMatrix=function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getViewMatrix)return a[b].getViewMatrix();a=this.position;b=this.orientation;var c=b.axis;return(new window.XML3DMatrix).translate(a.x,a.y,a.z).rotateAxisAngle(c.x,c.y,c.z,b.angle).inverse()};b.xml3dGetElementByPoint=function(a,b,c,d){var i=this._configured.adapters||{},j;for(j in i)if(i[j].getElementByPoint)return i[j].getElementByPoint(a,b,c,d);return null};b.xml3dGenerateRay=function(a,b){var c=this._configured.adapters||
{},d;for(d in c)if(c[d].xml3dGenerateRay)return c[d].xml3dGenerateRay(a,b);return new window.XML3DRay};b.groupGetLocalMatrix=function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getLocalMatrix)return a[b].getLocalMatrix();return new window.XML3DMatrix};b.groupGetBoundingBox=function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getBoundingBox)return a[b].getBoundingBox();return new window.XML3DBox};b.xml3dGetBoundingBox=b.groupGetBoundingBox;b.meshGetBoundingBox=function(){var a=
this._configured.adapters||{},b;for(b in a)if(a[b].getBoundingBox)return a[b].getBoundingBox();return new window.XML3DBox};b.XML3DGraphTypeGetWorldMatrix=function(){var a=this._configured.adapters||{},b;for(b in a)if(a[b].getWorldMatrix)return a[b].getWorldMatrix();return new window.XML3DMatrix};b.dataGetOutputFieldNames=function(){XML3D.debug.logError(this.nodeName+"::getOutputFieldNames is not implemeted yet.");return null};b.dataGetResult=function(){XML3D.debug.logError(this.nodeName+"::getResult is not implemeted yet.");
return null};XML3D.extend(XML3D.methods,b)};XML3D.MeshTypes={};XML3D.MeshTypes.triangles=0;XML3D.MeshTypes[0]="triangles";XML3D.MeshTypes.trianglestrips=1;XML3D.MeshTypes[1]="trianglestrips";XML3D.MeshTypes.lines=2;XML3D.MeshTypes[2]="lines";XML3D.MeshTypes.linestrips=3;XML3D.MeshTypes[3]="linestrips";XML3D.TextureTypes={};XML3D.TextureTypes["2d"]=0;XML3D.TextureTypes[0]="2d";XML3D.TextureTypes["1d"]=1;XML3D.TextureTypes[1]="1d";XML3D.TextureTypes["3d"]=2;XML3D.TextureTypes[2]="3d";XML3D.FilterTypes={};XML3D.FilterTypes.none=0;
XML3D.FilterTypes[0]="none";XML3D.FilterTypes.nearest=1;XML3D.FilterTypes[1]="nearest";XML3D.FilterTypes.linear=2;XML3D.FilterTypes[2]="linear";XML3D.WrapTypes={};XML3D.WrapTypes.clamp=0;XML3D.WrapTypes[0]="clamp";XML3D.WrapTypes.repeat=1;XML3D.WrapTypes[1]="repeat";XML3D.WrapTypes.border=2;XML3D.WrapTypes[2]="border";XML3D.DataFieldType={};XML3D.DataFieldType["float "]=0;XML3D.DataFieldType[0]="float ";XML3D.DataFieldType["float2 "]=1;XML3D.DataFieldType[1]="float2 ";XML3D.DataFieldType.float3=2;
XML3D.DataFieldType[2]="float3";XML3D.DataFieldType.float4=3;XML3D.DataFieldType[3]="float4";XML3D.DataFieldType.float4x4=4;XML3D.DataFieldType[4]="float4x4";XML3D.DataFieldType["int"]=5;XML3D.DataFieldType[5]="int";XML3D.DataFieldType.bool=6;XML3D.DataFieldType[6]="bool";XML3D.DataFieldType.texture=7;XML3D.DataFieldType[7]="texture";XML3D.DataFieldType.video=8;XML3D.DataFieldType[8]="video";XML3D.classInfo={};
XML3D.classInfo.xml3d={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.CanvasClassHandler,id:"class"},style:{a:XML3D.CanvasStyleHandler},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},
onkeyup:{a:XML3D.EventAttributeHandler},height:{a:XML3D.IntAttributeHandler,params:600},width:{a:XML3D.IntAttributeHandler,params:800},createXML3DVec3:{m:XML3D.methods.xml3dCreateXML3DVec3},createXML3DRotation:{m:XML3D.methods.xml3dCreateXML3DRotation},createXML3DMatrix:{m:XML3D.methods.xml3dCreateXML3DMatrix},createXML3DRay:{m:XML3D.methods.xml3dCreateXML3DRay},getElementByPoint:{m:XML3D.methods.xml3dGetElementByPoint},generateRay:{m:XML3D.methods.xml3dGenerateRay},getElementByRay:{m:XML3D.methods.xml3dGetElementByRay},
getBoundingBox:{m:XML3D.methods.xml3dGetBoundingBox},activeView:{a:XML3D.ReferenceHandler},_term:void 0};XML3D.classInfo.data={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},map:{a:XML3D.StringAttributeHandler},expose:{a:XML3D.StringAttributeHandler},getResult:{m:XML3D.methods.dataGetResult},getOutputFieldNames:{m:XML3D.methods.dataGetOutputFieldNames},src:{a:XML3D.ReferenceHandler},proto:{a:XML3D.ReferenceHandler},script:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.defs={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},_term:void 0};
XML3D.classInfo.group={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},getLocalMatrix:{m:XML3D.methods.groupGetLocalMatrix},getBoundingBox:{m:XML3D.methods.groupGetBoundingBox},transform:{a:XML3D.ReferenceHandler},shader:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.mesh={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},type:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.MeshTypes,d:0}},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},getBoundingBox:{m:XML3D.methods.meshGetBoundingBox},src:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.transform={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},translation:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},scale:{a:XML3D.XML3DVec3AttributeHandler,params:[1,1,1]},rotation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},center:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},scaleOrientation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},_term:void 0};
XML3D.classInfo.shader={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},script:{a:XML3D.ReferenceHandler},src:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.light={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},global:{a:XML3D.BoolAttributeHandler,params:!1},intensity:{a:XML3D.FloatAttributeHandler,params:1},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},shader:{a:XML3D.ReferenceHandler},_term:void 0};XML3D.classInfo.lightshader={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},script:{a:XML3D.ReferenceHandler},src:{a:XML3D.ReferenceHandler},_term:void 0};
XML3D.classInfo.script={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},value:{a:XML3D.StringAttributeHandler},src:{a:XML3D.StringAttributeHandler},type:{a:XML3D.StringAttributeHandler},_term:void 0};
XML3D.classInfo["float"]={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},replaceby:{a:XML3D.StringAttributeHandler},seqnr:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.FloatArrayValueHandler},_term:void 0};
XML3D.classInfo.float2={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},replaceby:{a:XML3D.StringAttributeHandler},seqnr:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float2ArrayValueHandler},_term:void 0};
XML3D.classInfo.float3={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},replaceby:{a:XML3D.StringAttributeHandler},seqnr:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float3ArrayValueHandler},_term:void 0};
XML3D.classInfo.float4={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},replaceby:{a:XML3D.StringAttributeHandler},seqnr:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float4ArrayValueHandler},_term:void 0};
XML3D.classInfo.float4x4={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},replaceby:{a:XML3D.StringAttributeHandler},seqnr:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.Float4x4ArrayValueHandler},_term:void 0};
XML3D.classInfo["int"]={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},replaceby:{a:XML3D.StringAttributeHandler},seqnr:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.IntArrayValueHandler},_term:void 0};
XML3D.classInfo.int4={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},replaceby:{a:XML3D.StringAttributeHandler},seqnr:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.IntArrayValueHandler},_term:void 0};
XML3D.classInfo.bool={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},replaceby:{a:XML3D.StringAttributeHandler},seqnr:{a:XML3D.FloatAttributeHandler,params:0},value:{a:XML3D.BoolArrayValueHandler},_term:void 0};
XML3D.classInfo.texture={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},name:{a:XML3D.StringAttributeHandler},replaceby:{a:XML3D.StringAttributeHandler},seqnr:{a:XML3D.FloatAttributeHandler,params:0},type:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.TextureTypes,d:0}},filterMin:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.FilterTypes,d:2}},filterMag:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.FilterTypes,d:2}},filterMip:{a:XML3D.EnumAttributeHandler,
params:{e:XML3D.FilterTypes,d:1}},wrapS:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,d:0}},wrapT:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,d:0}},wrapU:{a:XML3D.EnumAttributeHandler,params:{e:XML3D.WrapTypes,d:0}},borderColor:{a:XML3D.StringAttributeHandler},_term:void 0};XML3D.classInfo.img={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},src:{a:XML3D.StringAttributeHandler},_term:void 0};
XML3D.classInfo.video={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},src:{a:XML3D.StringAttributeHandler},_term:void 0};
XML3D.classInfo.view={id:{a:XML3D.StringAttributeHandler},className:{a:XML3D.StringAttributeHandler,id:"class"},onclick:{a:XML3D.EventAttributeHandler},ondblclick:{a:XML3D.EventAttributeHandler},onmousedown:{a:XML3D.EventAttributeHandler},onmouseup:{a:XML3D.EventAttributeHandler},onmouseover:{a:XML3D.EventAttributeHandler},onmousemove:{a:XML3D.EventAttributeHandler},onmouseout:{a:XML3D.EventAttributeHandler},onkeypress:{a:XML3D.EventAttributeHandler},onkeydown:{a:XML3D.EventAttributeHandler},onkeyup:{a:XML3D.EventAttributeHandler},
visible:{a:XML3D.BoolAttributeHandler,params:!0},position:{a:XML3D.XML3DVec3AttributeHandler,params:[0,0,0]},orientation:{a:XML3D.XML3DRotationAttributeHandler,params:[0,0,1,0]},fieldOfView:{a:XML3D.FloatAttributeHandler,params:0.785398},getWorldMatrix:{m:XML3D.methods.XML3DGraphTypeGetWorldMatrix},setDirection:{m:XML3D.methods.viewSetDirection},setUpVector:{m:XML3D.methods.viewSetUpVector},lookAt:{m:XML3D.methods.viewLookAt},getDirection:{m:XML3D.methods.viewGetDirection},getUpVector:{m:XML3D.methods.viewGetUpVector},
getViewMatrix:{m:XML3D.methods.viewGetViewMatrix},_term:void 0};XML3D.data=XML3D.data||{};
(function(){var b=function(){this.consumers=[]};b.prototype.getValue=function(){};b.prototype.getTupleSize=function(){};b.prototype.registerConsumer=function(a){for(var b=this.consumers.length,c=0;c<b;c++)if(this.consumers[c]==a){XML3D.debug.logWarning("Consumer "+a+" is already registered");return}this.consumers.push(a)};b.prototype.notifyDataChanged=function(){for(var a=this.consumers.length,b=0;b<a;b++)this.consumers[b].notifyDataChanged(this)};var a=function(a,b){this.consumers=[];this.data=[];
this.push=function(a){var b=a.key;if(void 0===b)throw"No key in entry for sequence";for(var c=this.data.length,d=0;d<c;d++)if(this.data[d].key==b){this.data.splice(d,1,a);return}this.data.push(a);this.data.sort(function(a,b){return a.key-b.key})};this.interpolate=function(a,b){if(a<=this.data[0].key)return this.data[0].value;if(a>=this.data[this.data.length-1])return this.data[this.data.length-1].value;for(var c=0;c<this.data.length-1;++c)if(this.data[c].key<a&&a<=this.data[c+1].key)return b(this.data[c].value,
this.data[c+1].value,(a-this.data[c].key)/(this.data[c+1].key-this.data[c].key))};this.getValue=function(){return this};this.push(a);this.push(b)};XML3D.createClass(a,b);var c=function(a,b){this.consumers=[];this.script=a;this.name=b;this.data={};this.script.registerConsumer(this);this.getValue=function(a){return this.script.getValue(this.name,a)};this.getTupleSize=function(){return this.script.getTupleSize(this.name)};this.toString=function(){return this.name+": "+this.script.toString()}};XML3D.createClass(c,
b);XML3D.data.ProcessTable=function(a,b,c){this.handler=a;this.fieldNames=b;this.callback=c;this.providers={};this.register=function(){for(var a in this.providers)this.providers[a].registerConsumer(this)};this.notifyDataChanged=function(a){this.callback&&this.callback.call(this.handler,this.providers,a)};this.toString=function(){var a;a="ProcessTable("+this.fieldNames.join(" ");return a+")"}};XML3D.data.ScriptOutput=c;XML3D.data.Sequence=a;XML3D.data.ProviderEntry=b})();XML3D.data=XML3D.data||{};
(function(){XML3D.data.DataAdapter=function(b,a){XML3D.data.Adapter.call(this,b,a);this.cachedOutputs=null;this.nameMap={};this.buildMap=function(){var a=this.node.map;if(a)for(var a=a.split(/\s+/),b=0;b<a.length;b++){var e=a[b].split(/\s*:=\s*/);this.nameMap[e[1]]=e[0]}}};XML3D.data.DataAdapter.prototype=new XML3D.data.Adapter;XML3D.data.DataAdapter.prototype.constructor=XML3D.data.DataAdapter;XML3D.data.DataAdapter.prototype.isAdapterFor=function(b){return b==XML3D.data.XML3DDataAdapterFactory.prototype};XML3D.data.DataAdapter.prototype.init=
function(){var b=this.resolveScript();b&&(this.scriptInstance=new XML3D.data.ScriptInstance(this,b));this.buildMap()};XML3D.data.DataAdapter.prototype.notifyChanged=function(b){XML3D.debug.logWarning("not handled change in data adapter: "+b)};XML3D.data.DataAdapter.prototype.getInputs=function(){if(this.cachedInputs)return this.cachedInputs;var b={};this.forEachChildAdapter(function(a){var a=a.getOutputs(),c;for(c in a){var d=b[c],e=a[c];d?d instanceof XML3D.data.Sequence?d.push(e):b[c]=d.key!=e.key?
new XML3D.data.Sequence(d,e):e:b[c]=a[c]}});return this.cachedInputs=b};XML3D.data.DataAdapter.prototype.getOutputs=function(){var b={},a=this.getInputs(),c;for(c in a)b[c]=a[c];if((a=this.resolveScript())&&a.outputs){a=a.outputs;for(c=0;c<a.length;c++)b[a[c].name]={script:this.scriptInstance,scriptOutputName:a[c].name}}for(var d in b)if(a=this.nameMap[d])b[a]=b[d],delete b[d];return b};XML3D.data.DataAdapter.prototype.resolveScript=function(){if(this.xflow)return this.xflow;var b=this.node.script;
if(!b)return null;var a=b.indexOf("urn:xml3d:xflow:"),c="";if(0===a)c=b.substring(16,b.length),XML3D.debug.logWarning("URN: "+b);else{b=XML3D.URIResolver.resolve(b,this.node.ownerDocument);if(!b)return null;a=b.textContent.indexOf("urn:xml3d:xflow:");0===a&&(c=b.textContent.substring(16,b.textContent.length))}this.xflow=XML3D.xflow.getScript(c);return void 0===this.xflow?(XML3D.debug.logError("No xflow script registered with name: "+c),null):this.xflow};XML3D.data.DataAdapter.prototype.requestInputData=
function(b,a,c,d){c=c||new XML3D.data.ProcessTable(b,a,d);this.forEachChildAdapter(function(d){d.requestOutputData(b,a,c,null)});d&&d.call(b,c.providers);return c};XML3D.data.DataAdapter.prototype.requestOutputData=function(b,a,c,d){c=c||new XML3D.data.ProcessTable(b,a,d);this.populateProcessTable(c);c.register();if(d)d.call(b,c.providers);else return c.providers};XML3D.data.DataAdapter.prototype.forEachChildAdapter=function(b){var a=this.node;if(a.src){if(a=XML3D.URIResolver.resolve(a.src,a.ownerDocument))(a=
this.factory.getAdapter(a,XML3D.data.XML3DDataAdapterFactory.prototype))&&b(a)}else for(a=this.node.firstElementChild;null!==a;a=a.nextElementSibling){var c=this.factory.getAdapter(a,XML3D.data.XML3DDataAdapterFactory.prototype);c&&b(c)}};XML3D.data.DataAdapter.prototype.populateProcessTable=function(b){for(var a=this.getOutputs(),c=b.fieldNames,d=0;d<c.length;d++){var e=c[d],g=a[e];g&&(g.script&&(g=new XML3D.data.ScriptOutput(g.script,g.scriptOutputName)),b.providers[e]=g)}};XML3D.data.DataAdapter.prototype.toString=
function(){return"XML3D.data.DataAdapter"}})();(function(){var b={"float":1,"int":1,bool:1,float2:2,float3:3,float4:4,int4:4,float4x4:16},a=function(a,d){XML3D.data.DataAdapter.call(this,a,d);XML3D.data.ProviderEntry.call(this);this.init=function(){this.value=this.node.value;this.key=this.node.seqnr;this.tupleSize=b[this.node.localName]};this.provider=new XML3D.data.ProviderEntry;this.data={}};XML3D.createClass(a,XML3D.data.DataAdapter);XML3D.extend(a.prototype,XML3D.data.ProviderEntry.prototype);a.prototype.getValue=function(){return this.node.value};
a.prototype.getTupleSize=function(){return this.tupleSize};a.prototype.getOutputs=function(){var a={};a[this.node.name]=this;return a};a.prototype.populateProcessTable=function(a){for(var b=a.fieldNames,e=0;e<b.length;e++)if(b[e]==this.node.name){a.providers[b[e]]=this;break}};a.prototype.notifyChanged=function(){this.notifyDataChanged(this)};a.prototype.toString=function(){return"XML3D.data.ValueDataAdapter"};XML3D.data.ValueDataAdapter=a})();(function(){var b=function(a,b){this.data=a;this.script=b;this.result={};this.needsEvaluation=!0;this.observers=[];this.getValue=function(a,b){this.needsEvaluation&&this.evaluate();b&&b();return this.result[a]};this.getTupleSize=function(a){for(var b=0;b<this.script.outputs.length;b++)if(this.script.outputs[b].name==a)return this.script.outputs[b].tupleSize};this.dataChanged=function(a){this.needsEvaluation=!0;var b=[];this.script.params.forEach(function(c){var f=a[c];f?b.push(f.getValue()):(XML3D.debug.logError("Missing input in xflow script: "+
c),b.push(void 0))});this.args=b;this.notifyConsumers()};this.evaluate=function(){this.result={};try{XML3D.debug.logDebug("Evaluate "+this.script.name+" on "+this.data.node.id),this.script.evaluate.apply(this.result,this.args)}catch(a){XML3D.debug.logError("Failed to evaluate xflow script: "+a)}this.needsEvaluation=!1};this.registerConsumer=function(a){for(var b=this.observers.length,c=0;c<b;c++)if(this.observers[c]==a){XML3D.debug.logWarning("Observer "+a+" is already registered");return}this.observers.push(a)};
this.notifyConsumers=function(){for(var a=this.observers.length,b=0;b<a;b++)this.observers[b].notifyDataChanged(this)};this.table=new XML3D.data.ProcessTable(this,this.script.params,this.dataChanged);this.data.requestInputData(this,this.script.params,this.table,this.dataChanged);this.table.register()};b.prototype.toString=function(){return"ScriptInstance("+this.data.node.id+"/"+this.script.name+")"};XML3D.data.ScriptInstance=b})();(function(){var b=function(a){return"clamp"==a?WebGLRenderingContext.CLAMP_TO_EDGE:"repeat"==a?WebGLRenderingContext.REPEAT:WebGLRenderingContext.CLAMP_TO_EDGE},a=function(a){return"nearest"==a?WebGLRenderingContext.NEAREST:"linear"==a?WebGLRenderingContext.LINEAR:"mipmap_linear"==a?WebGLRenderingContext.LINEAR_MIPMAP_NEAREST:"mipmap_nearest"==a?WebGLRenderingContext.NEAREST_MIPMAP_NEAREST:WebGLRenderingContext.LINEAR},c=function(a,b){XML3D.data.DataAdapter.call(this,a,b);XML3D.data.ProviderEntry.call(this)};
XML3D.createClass(c,XML3D.data.DataAdapter);XML3D.extend(c.prototype,XML3D.data.ProviderEntry.prototype);c.prototype.init=function(){var c=this.node,e={wrapS:b(c.wrapS),wrapT:b(c.wrapT),minFilter:a(c.filterMin),magFilter:a(c.filterMag),generateMipmap:!1};"true"==c.getAttribute("mipmap")&&(e.generateMipmap=!0);c=this.factory.getAdapter(c.firstElementChild,XML3D.data.XML3DDataAdapterFactory.prototype);c.requestOutputData?(c=c.requestOutputData(this,["image"]),e.imageAdapter=c.image):e.imageAdapter=
c;this.value=e};c.prototype.getOutputs=function(){var a={};a[this.node.name]=this;return a};c.prototype.getValue=function(){return this.value};c.prototype.toString=function(){return"XML3D.data.TextureDataAdapter"};XML3D.data.TextureDataAdapter=c})();(function(){var b=function(a,b){XML3D.data.DataAdapter.call(this,a,b)};XML3D.createClass(b,XML3D.data.DataAdapter);b.prototype.isSinkAdapter=function(){return!0};b.prototype.toString=function(){return"XML3D.data.SinkDataAdapter"};XML3D.data.SinkDataAdapter=b;b=function(a,b){XML3D.data.DataAdapter.call(this,a,b);XML3D.data.ProviderEntry.call(this);this.image=null};XML3D.createClass(b,XML3D.data.DataAdapter);XML3D.extend(b.prototype,XML3D.data.ProviderEntry.prototype);b.prototype.getValue=function(a){if(!this.image){var b=
this.node.src,d=new Image;d.onload=a;d.src=b;this.image=d}return this.image};b.prototype.getOutputs=function(){return{image:this}};XML3D.data.ImgDataAdapter=b})();(function(){var b=function(a){XML3D.data.AdapterFactory.call(this);this.handler=a};XML3D.createClass(b,XML3D.data.AdapterFactory);b.prototype.getAdapter=function(a){return XML3D.data.AdapterFactory.prototype.getAdapter.call(this,a,XML3D.data.XML3DDataAdapterFactory.prototype)};var a=XML3D.data,c={};c.mesh=a.SinkDataAdapter;c.shader=a.SinkDataAdapter;c.lightshader=a.SinkDataAdapter;c["float"]=a.ValueDataAdapter;c.float2=a.ValueDataAdapter;c.float3=a.ValueDataAdapter;c.float4=a.ValueDataAdapter;c.float4x4=
a.ValueDataAdapter;c["int"]=a.ValueDataAdapter;c.int4=a.ValueDataAdapter;c.bool=a.ValueDataAdapter;c.img=a.ImgDataAdapter;c.texture=a.TextureDataAdapter;c.data=a.DataAdapter;b.prototype.createAdapter=function(a){XML3D.debug.logDebug("Creating adapter: "+a.localName);var b=c[a.localName];if(void 0!==b)return new b(this,a);XML3D.debug.logWarning("Not supported as data element: "+a.localName);return null};XML3D.data.XML3DDataAdapterFactory=b})();XML3D.webgl=XML3D.webgl||{};XML3D.webgl.MAXFPS=30;
(function(){function b(a,b){this.canvas=a;this.xml3dElem=b;this.gl=a.getContext("experimental-webgl",{preserveDrawingBuffer:!0});this.needPickingDraw=this.needDraw=!0;this._pickingDisabled=!1;this._lastPickedObj=null;this.isDragging=this.mouseMovePickingEnabled=!1;this.timeNow=Date.now()/1E3;this.postProcessShaders=[];this.canvasInfo={id:a.id,mouseButtonsDown:[!1,!1]};this.registerCanvasListeners();var d=this;this._tick=function(){d.update()&&d.draw();window.requestAnimFrame(d._tick,XML3D.webgl.MAXFPS)};
this.redraw=function(a,b){void 0!==this.needDraw?(this.needDraw=!0,this.needPickingDraw=this.needPickingDraw||(void 0===b?!0:b)):d.needDraw=!0};this.renderer=new XML3D.webgl.Renderer(this,a.clientWidth,a.clientHeight)}b.prototype.registerCanvasListeners=function(){var a=this,b=this.canvas;b.addEventListener("mousedown",function(b){a.mouseDown(b)},!1);b.addEventListener("mouseup",function(b){a.mouseUp(b)},!1);b.addEventListener("mousemove",function(b){a.mouseMove(b)},!1);b.addEventListener("click",
function(b){a.click(b)},!1);b.addEventListener("dblclick",function(b){a.click(b,!0)},!1);b.addEventListener("mousewheel",function(b){a.mouseWheel(b)},!1);b.addEventListener("DOMMouseScroll",function(b){a.mouseWheel(b)},!1);b.addEventListener("mouseout",function(b){a.mouseOut(b)},!1);b=this.xml3dElem.getAttribute("contextmenu");(!b||"false"==b)&&this.canvas.addEventListener("contextmenu",function(a){XML3D.webgl.stopEvent(a)},!1)};b.prototype.start=function(){var a=this.gl;a.pixelStorei(a.PACK_ALIGNMENT,
1);a.pixelStorei(a.UNPACK_ALIGNMENT,1);a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0);a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.BROWSER_DEFAULT_WEBGL);this._tick()};b.prototype.resize=function(a,b,d){if(1>b||1>d)return!1;this.renderer.resize(b,d);return!0};b.prototype.renderPick=function(a,b){this._pickingDisabled||(this.renderer.renderPickingPass(a,this.canvas.height-b,this.needPickingDraw),this.needPickingDraw=!1)};b.prototype.renderPickedNormals=
function(a,b,d){a&&!this._pickingDisabled&&this.renderer.renderPickedNormals(a,b,this.canvas.height-d)};b.prototype.generateRay=function(a,b){var d=[0,0];d[2]=this.renderer.width;d[3]=this.renderer.height;var e=this.renderer.camera.viewMatrix,g=this.renderer.camera.getProjectionMatrix(d[2]/d[3]),f=new window.XML3DRay,h=[],i=[];if(!1===GLU.unProject(a,b,0,e,g,d,h)||!1===GLU.unProject(a,b,1,e,g,d,i))return f;f.origin=this.renderer.currentView.position;f.direction=new window.XML3DVec3(i[0]-h[0],i[1]-
h[1],i[2]-h[2]);f.direction=f.direction.normalize();return f};b.prototype.update=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("update",!0,!0,null);this.xml3dElem.dispatchEvent(a);return this.needDraw};b.prototype.draw=function(){try{var a=Date.now(),b=this.renderer.render(this.gl),d=Date.now();this.needDraw=!1;this.dispatchFrameDrawnEvent(a,d,b)}catch(e){throw XML3D.debug.logException(e),e;}};b.prototype.dispatchMouseEvent=function(a,b,d,e,g,f){if(null===g||void 0===g)g=
document.createEvent("MouseEvents"),g.initMouseEvent(a,!0,!0,window,0,0,0,d,e,!1,!1,!1,!1,b,null);a=this.copyMouseEvent(g);this.initExtendedMouseEvent(a,d,e);d=null;d=void 0!==f&&null!==f?f:this.xml3dElem.currentPickObj?this.xml3dElem.currentPickObj:this.xml3dElem;d.dispatchEvent(a);d=this.xml3dElem;d.dispatchEvent(a)};b.prototype.copyMouseEvent=function(a){var b=document.createEvent("MouseEvents");b.initMouseEvent(a.type,a.bubbles,a.cancelable,a.view,a.detail,a.screenX,a.screenY,a.clientX,a.clientY,
a.ctrlKey,a.altKey,a.shiftKey,a.metaKey,a.button,a.relatedTarget);return b};b.prototype.initExtendedMouseEvent=function(a,b,d){var e=this,g=this.xml3dElem;a.__defineGetter__("normal",function(){e.renderPickedNormals(g.currentPickObj,b,d);var a=g.currentPickNormal.v;return new window.XML3DVec3(a[0],a[1],a[2])});a.__defineGetter__("position",function(){return g.currentPickPos})};b.prototype.mouseUp=function(a){this.canvasInfo.mouseButtonsDown[a.button]=!1;var b=this.getMousePosition(a);this.isDragging&&
(this.needPickingDraw=!0,this.isDragging=!1);this.renderPick(b.x,b.y);this.dispatchMouseEvent("mouseup",a.button,b.x,b.y,a);return!1};b.prototype.mouseDown=function(a){this.canvasInfo.mouseButtonsDown[a.button]=!0;var b=this.getMousePosition(a);this.renderPick(b.x,b.y);this.dispatchMouseEvent("mousedown",a.button,b.x,b.y,a);return!1};b.prototype.click=function(a,b){var d=this.getMousePosition(a);if(this.isDragging)this.needPickingDraw=!0;else return!0==b?this.dispatchMouseEvent("dblclick",a.button,
d.x,d.y,a):this.dispatchMouseEvent("click",a.button,d.x,d.y,a),!1};b.prototype.mouseMove=function(a){var b=this.getMousePosition(a);this.canvasInfo.mouseButtonsDown[0]&&(this.isDragging=!0);this.dispatchMouseEvent("mousemove",0,b.x,b.y,a,this.xml3dElem);if(this.mouseMovePickingEnabled)return this.renderPick(b.x,b.y),a=null,this.xml3dElem.currentPickObj&&(a=this.xml3dElem.currentPickObj),a!==this._lastPickedObj&&(this._lastPickedObj&&this.dispatchMouseEvent("mouseout",0,b.x,b.y,null,this._lastPickedObj),
a&&this.dispatchMouseEvent("mouseover",0,b.x,b.y),this._lastPickedObj=a),!1};b.prototype.mouseOut=function(a){var b=this.getMousePosition(a);this.dispatchMouseEvent("mouseout",0,b.x,b.y,a,this.xml3dElem);return!1};b.prototype.mouseWheel=function(a){var b=this.getMousePosition(a);this.dispatchMouseEvent("mousewheel",0,b.x,b.y,a,this.xml3dElem);return!1};b.prototype.dispatchFrameDrawnEvent=function(a,b,d){var e=document.createEvent("CustomEvent");e.initCustomEvent("framedrawn",!0,!0,{timeStart:a,timeEnd:b,
renderTimeInMilliseconds:b-a,numberOfObjectsDrawn:d[0],numberOfTrianglesDrawn:Math.floor(d[1])});this.xml3dElem.dispatchEvent(e)};b.prototype.shutdown=function(){this.renderer&&this.renderer.dispose()};b.prototype.getMousePosition=function(a){var b=this.canvas.getBoundingClientRect();return{x:a.clientX-b.left,y:a.clientY-b.top}};b.prototype.setMouseMovePicking=function(a){this.mouseMovePickingEnabled=a};XML3D.webgl.CanvasHandler=b})();
XML3D.webgl.createCanvas=function(b){var a=b.parentNode,c=a.ownerDocument.createElement("div");c.style.display="none";a.insertBefore(c,b);c.appendChild(b);var d=b._configured.canvas;a.insertBefore(d,c);b=d.ownerDocument.defaultView.getComputedStyle(b);if(!d.style.backgroundColor&&(b=b.getPropertyValue("background-color"))&&"transparent"!=b)d.style.backgroundColor=b;d.width=d.clientWidth;d.height=d.clientHeight;return d};
XML3D.webgl.stopEvent=function(b){b.preventDefault&&b.preventDefault();b.stopPropagation&&b.stopPropagation();b.returnValue=!1};(function(){var b=new Float32Array(6);XML3D.webgl.calculateBoundingBox=function(a,d){var e=new window.XML3DBox;if(!a||3>a.length)return e;if(d){var g=3*d[0];b[0]=a[g];b[1]=a[g+1];b[2]=a[g+2];b[3]=a[g];b[4]=a[g+1];b[5]=a[g+2];for(g=1;g<d.length;g++){var f=3*d[g],h=a[f],i=a[f+1],f=a[f+2];h<b[0]&&(b[0]=h);i<b[1]&&(b[1]=i);f<b[2]&&(b[2]=f);h>b[3]&&(b[3]=h);i>b[4]&&(b[4]=i);f>b[5]&&(b[5]=f)}}else{b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[0];b[4]=a[1];b[5]=a[2];for(g=3;g<a.length;g+=3)a[g]<b[0]&&(b[0]=a[g]),
a[g+1]<b[1]&&(b[1]=a[g+1]),a[g+2]<b[2]&&(b[2]=a[g+2]),a[g]>b[3]&&(b[3]=a[g]),a[g+1]>b[4]&&(b[4]=a[g+1]),a[g+2]>b[5]&&(b[5]=a[g+2])}e.min.set(b[0],b[1],b[2]);e.max.set(b[3],b[4],b[5]);return e};var a=mat4.create();XML3D.webgl.transformAABB=function(b,d){if(!b.isEmpty()){var e=b.min._data,g=b.max._data,f=vec3.scale(vec3.add(e,g,vec3.create()),0.5),e=vec3.scale(vec3.subtract(g,e,vec3.create()),0.5);mat4.toRotationMat(d,a);for(g=0;16>g;g++)a[g]=Math.abs(a[g]);mat4.multiplyVec3(a,e);mat4.multiplyVec3(d,
f);vec3.add(f,e,b.max._data);vec3.subtract(f,e,b.min._data)}};XML3D.webgl.splitMesh=function(a,b){var b=3*Math.floor(b/3),e=a.position.data,g=a.index?a.index.data:void 0,f=a.normal?a.normal.data:void 0,h=a.texcoord?a.texcoord.data:void 0,i=a.color?a.color.data:void 0,j=a.position.tupleSize,k=a.texcoord?a.texcoord.tupleSize:void 0,l=g.length;if(g){for(var n=[],o=Math.ceil(l/b),l=[],m=0;m<o;m++)if(l[m]={},l[m].index=new Uint16Array(b),l[m].index.nextFreeSlot=0,l[m].position=new Float32Array(b*j),f&&
(l[m].normal=new Float32Array(b*j)),h&&(l[m].texcoord=new Float32Array(b*k)),i)l[m].color=new Float32Array(3*b);for(m=0;m<g.length;m+=3){var p=!0,o=Math.floor(g[m]/b);l[o].index.nextFreeSlot+3>b&&(p=!1);for(r=1;3>r;r++)if(Math.floor(g[m+r]/b)!=o){p=!1;break}if(p)for(var p=b*o,r=0;3>r;r++){var u=g[m+r],v=u-p,s=l[o];s.index[s.index.nextFreeSlot]=v;s.index.nextFreeSlot++;for(var w=u*j,t=[],q=0;q<j;q++)t[q]=e[w+q];s.position.set(t,v*j);if(f){t=[];for(q=0;q<j;q++)t[q]=f[w+q];s.normal.set(t,v*j)}u*=k;if(h){t=
[];for(q=0;q<k;q++)t[q]=h[u+q];s.texcoord.set(t,v*k)}if(i){t=[];for(q=0;3>q;q++)t[q]=i[w+q];s.color.set(t,3*v)}}else n.push(m)}for(m=o=0;m<n.length;m++){for(;l[o].index.nextFreeSlot+3>b;)if(o++,o>=l.length){l[o]={};l[o].index=new Uint16Array(b);l[o].index.nextFreeSlot=0;l[o].position=new Float32Array(b*j);f&&(l[o].normal=new Float32Array(b*j));h&&(l[o].texcoord=new Float32Array(b*k));i&&(l[o].color=new Float32Array(3*b));break}for(r=0;3>r;r++){s=l[o];u=g[n[m]+r];v=s.index.nextFreeSlot;s.index[v]=
v;s.index.nextFreeSlot++;t=[];for(q=0;q<j;q++)t[q]=e[u*j+q];s.position.set(t,v*j);if(f){t=[];for(q=0;q<j;q++)t[q]=f[u*j+q];s.normal.set(t,v*j)}if(h){t=[];for(q=0;q<k;q++)t[q]=h[u*k+q];s.texcoord.set(t,v*k)}if(i){t=[];for(q=0;q<j;q++)t[q]=i[3*u+q];s.color.set(t,3*v)}}}a.index=[];a.position=[];f&&(a.normal=[]);h&&(a.texcoord=[]);i&&(a.color=[]);for(m=0;m<l.length;m++)0<l[m].index.nextFreeSlot&&(a.index[m]={data:l[m].index,tupleSize:j},a.position[m]={data:l[m].position,tupleSize:j},f&&(a.normal[m]={data:l[m].normal,
tupleSize:j}),h&&(a.texcoord[m]={data:l[m].texcoord,tupleSize:k}),i&&(a.color[m]={data:l[m].color,tupleSize:3}))}}})();XML3D.webgl.XML3DShaderManager=function(b,a,c,d){this.gl=b;this.renderer=a;this.dataFactory=c;this.factory=d;this.currentProgram=null;this.shaders={};a=this.getStandardShaderProgram("urn:xml3d:shader:flat");a.hasTransparency=!1;this.bindShader(a);this.setUniform(b,a.uniforms.diffuseColor,[1,0,0]);this.unbindShader(a);this.shaders.defaultShader=a;this.shaders.picking=this.getStandardShaderProgram("urn:xml3d:shader:picking");this.shaders.pickedNormals=this.getStandardShaderProgram("urn:xml3d:shader:pickedNormals")};
XML3D.webgl.XML3DShaderManager.prototype.createShader=function(b,a){var c=null,d="defaultShader",e=null;b&&(e=b.node,d=e.id);if(c=this.shaders[d])return d;var c={vs:null,fs:null},g={hasTextures:!1,hasTransparency:!1,hasVColors:!1};if(b){var f=b.requestData(["transparency","diffuseTexture","useVertexColor"]);f.transparency&&(g.hasTransparency=0<f.transparency.value[0]);g.hasTextures=void 0!==f.diffuseTexture;g.hasVColors=f.useVertexColor&&!0==f.useVertexColor.value[0]}e&&e.hasAttribute("script")?(f=
e.getAttribute("script"),"urn"==(new XML3D.URI(f)).scheme?this.getStandardShaderSource(f,c,b,a,g):(e=XML3D.URIResolver.resolve(f+"-vs"),f=XML3D.URIResolver.resolve(f+"-fs"),e&&f&&(c.vs=e.textContent,c.fs=f.textContent)),c=this.createShaderFromSources(c),c.hasTransparency=g.hasTransparency,this.shaders[d]=c):(c=this.shaders.defaultShader,d="defaultShader");if(b)if(this.createTextures(c,b)){var g=[],h;for(h in c.uniforms)g.push(h);f=b.requestData(g);this.setUniformVariables(c,f)}else this.destroyShader(c),
d="defaultShader";return d};
XML3D.webgl.XML3DShaderManager.prototype.getStandardShaderSource=function(b,a,c,d,e){"urn:xml3d:shader:phong"==b&&e.hasTextures?b="urn:xml3d:shader:texturedphong":"urn:xml3d:shader:diffuse"==b&&e.hasTextures&&(b="urn:xml3d:shader:textureddiffuse");e.hasVColors&&(b+="vcolor");switch(b){case "urn:xml3d:shader:phong":case "urn:xml3d:shader:texturedphong":case "urn:xml3d:shader:phongvcolor":case "urn:xml3d:shader:diffuse":case "urn:xml3d:shader:textureddiffuse":case "urn:xml3d:shader:diffusevcolor":c="#define MAXLIGHTS "+
d.length.toString()+"\n"+g_shaders[b].fragment;a.vs=g_shaders[b].vertex;a.fs=c;break;default:g_shaders[b]&&(a.vs=g_shaders[b].vertex,a.fs=g_shaders[b].fragment)}};XML3D.webgl.XML3DShaderManager.prototype.getStandardShaderProgram=function(b){var a={};g_shaders[b]?(a.vs=g_shaders[b].vertex,a.fs=g_shaders[b].fragment):XML3D.debug.logError("Unknown shader: "+b+". Using flat shader instead.");return this.createShaderFromSources(a)};
XML3D.webgl.XML3DShaderManager.prototype.createShaderFromSources=function(b){var a=this.gl;if(!b.vs||!b.fs)return this.shaders.defaultShader;var c=a.createProgram(),d=this.compileShader(a.VERTEX_SHADER,b.vs),e=this.compileShader(a.FRAGMENT_SHADER,b.fs);if(null===d||null===e)return this.shaders.defaultShader;a.attachShader(c,d);a.attachShader(c,e);a.linkProgram(c);if(0==a.getProgramParameter(c,a.LINK_STATUS))return c="Shader linking failed: \n"+a.getProgramInfoLog(c),XML3D.debug.logError(c+"\n--------\n"),
a.getError(),this.shaders.defaultShaders;b={attributes:{},uniforms:{},samplers:{},handle:c,vSource:b.vs,fSource:b.fs};a.useProgram(c);e=a.getProgramParameter(c,a.ACTIVE_ATTRIBUTES);for(d=0;d<e;d++){var g=a.getActiveAttrib(c,d);if(g){var f={};f.name=g.name;f.size=g.size;f.glType=g.type;f.location=a.getAttribLocation(c,g.name);b.attributes[g.name]=f}}e=0;g=a.getProgramParameter(c,a.ACTIVE_UNIFORMS);for(d=0;d<g;d++)if(f=a.getActiveUniform(c,d)){var h={};h.name=f.name;h.size=f.size;h.glType=f.type;h.location=
a.getUniformLocation(c,f.name);f.type==a.SAMPLER_2D||f.type==a.SAMPLER_CUBE?(h.texUnit=e,b.samplers[f.name]=h,e++):b.uniforms[f.name]=h}this.setStandardUniforms(b);b.changes=[];return b};
XML3D.webgl.XML3DShaderManager.prototype.compileShader=function(b,a){var c=this.gl,d=c.createShader(b);c.shaderSource(d,a);c.compileShader(d);if(0==c.getShaderParameter(d,c.COMPILE_STATUS)){var e="",e=b==c.VERTEX_SHADER?"Vertex shader failed to compile: \n":"Fragment shader failed to compile: \n",e=e+(c.getShaderInfoLog(d)+"\n--------\n");XML3D.debug.logError(e);c.getError();return null}return d};
XML3D.webgl.XML3DShaderManager.prototype.recompileShader=function(b,a){var c=b.node.id,d=this.shaders[c];d&&(this.destroyShader(d),delete this.shaders[c],this.createShader(b,a))};XML3D.webgl.XML3DShaderManager.prototype.shaderDataChanged=function(b,a,c,d){b=this.shaders[b];"src"==a?d?(a=b.samplers[d])&&this.replaceTexture(a,c):XML3D.debug.logError("Couldn't apply change because of a missing texture name"):("transparency"==a&&(b.hasTransparency=0<c),b.changes.push({type:"uniform",name:a,newValue:c}))};
XML3D.webgl.XML3DShaderManager.prototype.setStandardUniforms=function(b){var a=this.gl,c=null;(c=b.uniforms.diffuseColor)&&this.setUniform(a,c,[1,1,1]);(c=b.uniforms.emissiveColor)&&this.setUniform(a,c,[0,0,0]);(c=b.uniforms.specularColor)&&this.setUniform(a,c,[0,0,0]);(c=b.uniforms.shininess)&&this.setUniform(a,c,0.2);(c=b.uniforms.transparency)&&this.setUniform(a,c,0)};
XML3D.webgl.XML3DShaderManager.prototype.getShaderById=function(b){var a=this.shaders[b];if(!a){if(a=this.factory.getAdapter(document.getElementById(b)))if(this.createShader(a,this.renderer.lights),this.shaders[b])return this.shaders[b];XML3D.debug.logError("Could not find the shader [ "+b+" ]");a=this.shaders["default"]}return a};
XML3D.webgl.XML3DShaderManager.prototype.setUniformVariables=function(b,a){this.bindShader(b);for(var c in a){var d=a[c];d.value&&(d=d.value);d.clean||(1==d.length&&(d=d[0]),b.uniforms[c]&&this.setUniform(this.gl,b.uniforms[c],d))}};XML3D.webgl.XML3DShaderManager.prototype.bindShader=function(b){b="string"==typeof b?this.getShaderById(b):b;this.currentProgram!=b.handle&&(this.currentProgram=b.handle,this.gl.useProgram(b.handle));var b=b.samplers,a;for(a in b)this.bindTexture(b[a])};
XML3D.webgl.XML3DShaderManager.prototype.updateShader=function(b){this.bindShader(b);for(var a=0,c=b.changes.length;a<c;a++){var d=b.changes[a];"uniform"==d.type&&b.uniforms[d.name]&&this.setUniform(this.gl,b.uniforms[d.name],d.newValue)}b.changes=[]};XML3D.webgl.XML3DShaderManager.prototype.unbindShader=function(b){var b=("string"==typeof b?this.getShaderById(b):b).samplers,a;for(a in b)this.unbindTexture(b[a]);this.currentProgram=null;this.gl.useProgram(null)};
XML3D.webgl.XML3DShaderManager.prototype.setUniform=function(b,a,c){switch(a.glType){case 35670:case 5124:case 35678:b.uniform1i(a.location,c);break;case 35671:case 35667:b.uniform2iv(a.location,c);break;case 35672:case 35668:b.uniform3iv(a.location,c);break;case 35673:case 35669:b.uniform4iv(a.location,c);break;case 5126:b.uniform1f(a.location,c);break;case 35664:b.uniform2fv(a.location,c);break;case 35665:b.uniform3fv(a.location,c);break;case 35666:b.uniform4fv(a.location,c);break;case 35674:b.uniformMatrix2fv(a.location,
b.FALSE,c);break;case 35675:b.uniformMatrix3fv(a.location,b.FALSE,c);break;case 35676:b.uniformMatrix4fv(a.location,b.FALSE,c);break;default:XML3D.debug.logError("Unknown uniform type "+a.glType)}};XML3D.webgl.XML3DShaderManager.prototype.setGLContext=function(b){this.gl=b};XML3D.webgl.XML3DShaderManager.prototype.destroyShader=function(b){for(var a in b.samplers)this.destroyTexture(b.samplers[a]);this.gl.deleteProgram(b.handle)};
XML3D.webgl.XML3DShaderManager.prototype.createTextures=function(b,a){var c=0,d=[],e;for(e in b.samplers)d.push(e);d=a.requestData(d);for(e in b.samplers){if(!d[e])return XML3D.debug.logWarning("Can't find required texture with name='"+e+"'. Using default shader instead."),!1;var g=b.samplers[e],f=d[e].getValue(),h={isDepth:!1,minFilter:f.minFilter,magFilter:f.magFilter,wrapS:f.wrapS,wrapT:f.wrapT,generateMipmap:f.generateMipmap,flipY:!0,premultiplyAlpha:!0},i=this.gl.createTexture();if(f.imageAdapter&&
f.imageAdapter.getValue){var j={status:0,texUnit:c,handle:i},k=this.renderer;j.image=f.imageAdapter.getValue(function(){j.status=1;k.requestRedraw.call(k,"Texture loaded")});g.info=j;g.options=h;c++}else g.info={status:!1},XML3D.debug.logWarning("No image found for texture: "+e)}return!0};
XML3D.webgl.XML3DShaderManager.prototype.replaceTexture=function(b,a){this.destroyTexture(b);var c=this.gl.createTexture(),d=this.loadImage(a);d.handle=c;c=b.info;d.format=c.format;d.glType=c.glType;d.options=c.options;d.valid=!1;b.info=d};
XML3D.webgl.XML3DShaderManager.prototype.createTex2DFromData=function(b,a,c,d,e,g,f){var h=this.gl,i={};g||(g=e==h.FLOAT?new Float32Array(4*a*c):new Uint8Array(4*a*c));var j=h.createTexture();h.bindTexture(h.TEXTURE_2D,j);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,f.wrapS);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,f.wrapT);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,f.minFilter);h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,f.magFilter);h.texImage2D(h.TEXTURE_2D,0,b,a,c,0,d,e,g);
f.isDepth&&(h.texParameteri(h.TEXTURE_2D,h.DEPTH_TEXTURE_MODE,f.depthMode),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_COMPARE_MODE,f.depthCompareMode),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_COMPARE_FUNC,f.depthCompareFunc));f.generateMipmap&&h.generateMipmap(h.TEXTURE_2D);h.bindTexture(h.TEXTURE_2D,null);i.handle=j;i.options=f;i.valid=!0;i.glType=h.TEXTURE_2D;i.format=b;return i};
XML3D.webgl.XML3DShaderManager.prototype.createTex2DFromImage=function(b,a){var c=this.gl,d={},e=b.image;c.bindTexture(c.TEXTURE_2D,b.handle);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_S,a.wrapS);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_WRAP_T,a.wrapT);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,a.minFilter);c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,a.magFilter);if(!this.isPowerOfTwo(e.width)||!this.isPowerOfTwo(e.height)){var g=document.createElement("canvas");g.width=this.nextHighestPowerOfTwo(e.width);
g.height=this.nextHighestPowerOfTwo(e.height);g.getContext("2d").drawImage(e,0,0,g.width,g.height);e=g}c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,e);a.generateMipmap&&c.generateMipmap(c.TEXTURE_2D);c.bindTexture(c.TEXTURE_2D,null);d.handle=b.handle;d.texUnit=b.texUnit;d.options=a;d.valid=!0;d.glType=c.TEXTURE_2D;d.format=c.RGBA;return d};
XML3D.webgl.XML3DShaderManager.prototype.bindTexture=function(b){var a=b.info;a.valid?(this.gl.activeTexture(this.gl.TEXTURE0+a.texUnit),this.gl.bindTexture(a.glType,a.handle)):a.status&&(b.info=this.createTex2DFromImage(a,b.options))};XML3D.webgl.XML3DShaderManager.prototype.unbindTexture=function(b){this.gl.activeTexture(this.gl.TEXTURE0+b.info.texUnit);this.gl.bindTexture(b.info.glType,null)};XML3D.webgl.XML3DShaderManager.prototype.destroyTexture=function(b){b.info&&b.info.handle&&this.gl.deleteTexture(b.info.handle)};
XML3D.webgl.XML3DShaderManager.prototype.isPowerOfTwo=function(b){return 0==(b&b-1)};XML3D.webgl.XML3DShaderManager.prototype.nextHighestPowerOfTwo=function(b){--b;for(var a=1;32>a;a<<=1)b|=b>>a;return b+1};XML3D.webgl.MAX_PICK_BUFFER_WIDTH=512;XML3D.webgl.MAX_PICK_BUFFER_HEIGHT=512;XML3D.webgl.XML3DBufferHandler=function(b,a,c){this.renderer=a;this.gl=b;this.shaderManager=c};
XML3D.webgl.XML3DBufferHandler.prototype.createPickingBuffer=function(b,a){var c=this.gl,d=1,e=a-XML3D.webgl.MAX_PICK_BUFFER_HEIGHT,g=b-XML3D.webgl.MAX_PICK_BUFFER_WIDTH;if(0<e||0<g)d=e>g?XML3D.webgl.MAX_PICK_BUFFER_HEIGHT/a:XML3D.webgl.MAX_PICK_BUFFER_WIDTH/b;b=Math.floor(b*d);a=Math.floor(a*d);return this.createFrameBuffer(b,a,c.RGBA,c.DEPTH_COMPONENT16,null,{depthAsRenderbuffer:!0},d)};XML3D.webgl.XML3DBufferHandler.prototype.createShadowBuffer=function(){};
XML3D.webgl.XML3DBufferHandler.prototype.createFrameBuffer=function(b,a,c,d,e,g,f){var h=this.gl,g=this.fillOptions(g),i=h.createFramebuffer();h.bindFramebuffer(h.FRAMEBUFFER,i);var j={handle:null,isTexture:!1};if(c)if(g.colorAsRenderbuffer){var k=h.createRenderbuffer();h.bindRenderbuffer(h.RENDERBUFFER,k);h.renderbufferStorage(h.RENDERBUFFER,c,b,a);h.bindRenderbuffer(h.RENDERBUFFER,null);h.framebufferRenderbuffer(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.RENDERBUFFER,k);j.handle=k;j.isTexture=!1}else c=
this.shaderManager.createTex2DFromData(c,b,a,h.RGBA,h.UNSIGNED_BYTE,null,g),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,c.handle,0),j.handle=i,j.isTexture=!0;c={handle:null,isTexture:!1};d&&(g.isDepth=!0,g.depthAsRenderbuffer?(k=h.createRenderbuffer(),h.bindRenderbuffer(h.RENDERBUFFER,k),h.renderbufferStorage(h.RENDERBUFFER,d,b,a),h.bindRenderbuffer(h.RENDERBUFFER,null),h.framebufferRenderbuffer(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.RENDERBUFFER,k),c.handle=k,c.isTexture=!1):
(d=this.shaderManager.createTex2DFromData(d,b,a,h.DEPTH_COMPONENT,h.FLOAT,null,g),h.framebufferTexture2D(h.FRAMEBUFFER,h.DEPTH_ATTACHMENT,h.TEXTURE_2D,d.handle,0),c.handle=d.handle,c.isTexture=!0));d={handle:null,isTexture:!1};e&&(g.isDepth=!1,g.stencilAsRenderbuffer?(g=h.createRenderbuffer(),h.bindRenderbuffer(h.RENDERBUFFER,g),h.renderbufferStorage(h.RENDERBUFFER,e,b,a),h.bindRenderbuffer(h.RENDERBUFFER,null),h.framebufferRenderbuffer(h.FRAMEBUFFER,h.STENCIL_ATTACHMENT,h.RENDERBUFFER,g),d.handle=
g,d.isTexture=!1):(e=this.shaderManager.createTex2DFromData(e,b,a,h.STENCIL_COMPONENT,h.UNSIGNED_BYTE,null,g),h.framebufferTexture2D(h.FRAMEBUFFER,h.STENCIL_ATTACHMENT,h.TEXTURE_2D,e.handle,0),d.handle=e.handle,d.isTexture=!0));e=h.checkFramebufferStatus(h.FRAMEBUFFER);switch(e){case h.FRAMEBUFFER_COMPLETE:break;case h.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case h.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");
break;case h.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case h.FRAMEBUFFER_UNSUPPORTED:XML3D.debug.logError("Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");break;default:XML3D.debug.logError("Incomplete framebuffer: "+e)}h.bindFramebuffer(h.FRAMEBUFFER,null);g={};g.handle=i;g.valid=e==h.FRAMEBUFFER_COMPLETE;g.width=b;g.height=a;g.colorTarget=j;g.depthTarget=c;g.stencilTarget=d;g.scale=f;return g};
XML3D.webgl.XML3DBufferHandler.prototype.destroyFrameBuffer=function(b){if(b.handle){var a=this.gl;a.deleteFramebuffer(b.handle);null!==b.colorTarget&&(b.colorTarget.isTexture?a.deleteTexture(b.colorTarget.handle):a.deleteRenderBuffer(b.colorTarget.handle));null!==b.depthTarget&&(b.depthTarget.isTexture?a.deleteTexture(b.depthTarget.handle):a.deleteRenderBuffer(b.depthTarget.handle));null!==b.stencilTarget&&(b.stencilTarget.isTexture?a.deleteTexture(b.stencilTarget.handle):a.deleteRenderBuffer(b.stencilTarget.handle))}};
XML3D.webgl.XML3DBufferHandler.prototype.fillOptions=function(b){var a=this.gl,a={wrapS:a.CLAMP_TO_EDGE,wrapT:a.CLAMP_TO_EDGE,minFilter:a.NEAREST,magFilter:a.NEAREST,depthMode:a.LUMINANCE,depthCompareMode:a.COMPARE_R_TO_TEXTURE,depthCompareFunc:a.LEQUAL,colorsAsRenderbuffer:!1,depthAsRenderbuffer:!1,stencilAsRenderbuffer:!1,isDepth:!1},c;for(c in b)a[c]=b[c];return a};(function(){var b=document.createElement("canvas");XML3D.webgl.supported=function(){try{return!(!window.WebGLRenderingContext||!b.getContext("experimental-webgl"))}catch(a){return!1}};XML3D.webgl.configure=function(a){for(var b in a){var c=XML3D.webgl.createCanvas(a[b],b);(new XML3D.webgl.CanvasHandler(c,a[b])).start()}};XML3D.webgl.checkError=function(a,b){var c=a.getError();if(c!==a.NO_ERROR){var f=""+c;switch(c){case 1280:f="1280 ( GL_INVALID_ENUM )";break;case 1281:f="1281 ( GL_INVALID_VALUE )";
break;case 1282:f="1282 ( GL_INVALID_OPERATION )";break;case 1283:f="1283 ( GL_STACK_OVERFLOW )";break;case 1284:f="1284 ( GL_STACK_UNDERFLOW )";break;case 1285:f="1285 ( GL_OUT_OF_MEMORY )"}c="GL error "+f+" occured.";void 0!==b&&(c+=" "+b);XML3D.debug.logError(c)}};XML3D.webgl.Renderer=function(a,b,c){this.handler=a;this.currentView=null;this.xml3dNode=a.xml3dElem;this.factory=new XML3D.webgl.XML3DRenderAdapterFactory(a,this);this.dataFactory=new XML3D.data.XML3DDataAdapterFactory(a);this.shaderManager=
new XML3D.webgl.XML3DShaderManager(a.gl,this,this.dataFactory,this.factory);this.bufferHandler=new XML3D.webgl.XML3DBufferHandler(a.gl,this,this.shaderManager);this.camera=this.initCamera();this.width=b;this.height=c;this.fbos=this.initFrameBuffers(a.gl);this.lights=[];this.drawableObjects=[];this.recursiveBuildScene(this.drawableObjects,this.xml3dNode,!0,mat4.identity(mat4.create()),null);this.processShaders(this.drawableObjects)};XML3D.webgl.Renderer.drawableObject=function(){this.transform=this.shader=
this.mesh=null;this.visible=!0;this.meshNode=null;var a=this;this.getObject=function(){return a}};XML3D.webgl.Renderer.prototype.initCamera=function(){var a=this.xml3dNode.activeView,b=null;""!=a&&(b=XML3D.URIResolver.resolve(a));if(null==b)return b=document.evaluate(".//xml3d:view[1]",this.xml3dNode,function(){return XML3D.xml3dNS},XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,null==b&&XML3D.debug.logError("No view defined."),this.currentView=b,this.factory.getAdapter(b);this.currentView=
b;return this.factory.getAdapter(b)};XML3D.webgl.Renderer.prototype.processShaders=function(a){for(var b=0,c=a.length;b<c;b++){var f=a[b],h=this.factory.getAdapter(f.meshNode.parentNode),h=this.shaderManager.createShader(h?h.getShader():null,this.lights);f.shader=h}};XML3D.webgl.Renderer.prototype.recursiveBuildScene=function(a,b,c,f,h){var i=this.factory.getAdapter(b),j=h,k=f;switch(b.nodeName){case "group":c=(i.parentVisible=c)&&b.visible;(b.hasAttribute("onmousemove")||b.hasAttribute("onmouseout"))&&
this.handler.setMouseMovePicking(!0);j=(j=i.getShader())?j:h;i.parentTransform=f;i.parentShader=h;i.isVisible=c;k=i.applyTransformMatrix(mat4.identity(mat4.create()));break;case "mesh":(b.hasAttribute("onmousemove")||b.hasAttribute("onmouseout"))&&this.handler.setMouseMovePicking(!0);h=this.factory.getAdapter(b);if(!h)break;i.parentVisible=c;var l=new XML3D.webgl.Renderer.drawableObject;l.meshNode=b;l.visible=c&&b.visible;l.shader=null;l.transform=f;i.registerCallback(l.getObject);h.createMesh();
a.push(l);break;case "light":this.lights.push({adapter:i,transform:f});i.transform=f;i.visible=c&&b.visible;break;case "view":i.parentTransform=f,i.updateViewMatrix()}for(b=b.firstElementChild;b;)this.recursiveBuildScene(a,b,c,k,j),b=b.nextSibling};XML3D.webgl.Renderer.prototype.initFrameBuffers=function(){var a={};a.picking=this.bufferHandler.createPickingBuffer(this.width,this.height);a.picking.valid||(this.handler._pickingDisabled=!0);return a};XML3D.webgl.Renderer.prototype.getGLContext=function(){return this.handler.gl};
XML3D.webgl.Renderer.prototype.recompileShader=function(a){this.shaderManager.recompileShader(a,this.lights);this.handler.redraw("A shader was recompiled")};XML3D.webgl.Renderer.prototype.shaderDataChanged=function(a,b,c,f){this.shaderManager.shaderDataChanged(a,b,c,f);"src"!=b&&this.handler.redraw("A shader parameter was changed")};XML3D.webgl.Renderer.prototype.removeDrawableObject=function(a){this.drawableObjects.splice(this.drawableObjects.indexOf(a),1)};XML3D.webgl.Renderer.prototype.setGLContext=
function(a){this.shaderManager.setGLContext(a);this.meshManager.setGLContext(a)};XML3D.webgl.Renderer.prototype.resizeCanvas=function(a,b){this.width=a;this.height=b};XML3D.webgl.Renderer.prototype.activeViewChanged=function(){this._viewMatrix=this._projMatrix=null;this.camera=this.initCamera();this.requestRedraw("Active view changed",!0)};XML3D.webgl.Renderer.prototype.requestRedraw=function(a,b){this.handler.redraw(a,b)};XML3D.webgl.Renderer.prototype.sceneTreeAddition=function(a){var b=this.factory.getAdapter(a.wrapped.target);
if(b){var c=mat4.identity(mat4.create()),f=!0,h=null;b.getShader&&(h=b.getShader());var i=a.wrapped.target;for(b.isValid=!0;i.parentElement;)if(i=i.parentElement,"group"==i.nodeName)b=this.factory.getAdapter(i),c=b.applyTransformMatrix(c),h||(h=b.getShader()),"false"==i.getAttribute("visible")&&(f=!1);else break;i=[];this.recursiveBuildScene(i,a.wrapped.target,f,c,h);this.processShaders(i);this.drawableObjects=this.drawableObjects.concat(i);this.requestRedraw("A node was added.")}};XML3D.webgl.Renderer.prototype.sceneTreeRemoval=
function(a){(a=this.factory.getAdapter(a.wrapped.target))&&a.destroy&&a.destroy();this.requestRedraw("A node was removed.")};XML3D.webgl.Renderer.prototype.render=function(){var a=this.handler.gl;a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT);a.viewport(0,0,this.width,this.height);a.enable(a.DEPTH_TEST);if(!this.camera)return[0,0];var b={};b.view=this.camera.viewMatrix;b.proj=this.camera.getProjectionMatrix(this.width/this.height);for(var c,f=this.lights,h=3*f.length,h={positions:new Float32Array(h),
diffuseColors:new Float32Array(h),ambientColors:new Float32Array(h),attenuations:new Float32Array(h),visible:new Float32Array(h)},i=0,j=f.length;i<j;i++)if(c=f[i].adapter,c=c.requestData(["position","attenuation","intensity","visiblility"],b.view))h.positions.set(c.position,3*i),h.attenuations.set(c.attenuation,3*i),h.diffuseColors.set(c.intensity,3*i),h.visible.set(c.visibility,3*i);f={objCount:0,triCount:0};c={};i=[];this.sortObjects(this.drawableObjects,c,i,b);a.blendFunc(a.SRC_ALPHA,a.ONE_MINUS_SRC_ALPHA);
for(var k in c)j=c[k],this.drawObjects(j,k,b,h,f);if(0<i.length){a.enable(a.BLEND);for(k=0;k<i.length;k++)j=[i[k]],this.drawObjects(j,j[0].shader,b,h,f);a.disable(a.BLEND)}return[f.objCount,f.triCount]};XML3D.webgl.Renderer.prototype.sortObjects=function(a,b,c,f,h){for(var i=[],j=0,k=a.length;j<k;j++){var l=a[j],n=l.shader;this.shaderManager.getShaderById(n).hasTransparency?i.push(l):(b[n]=b[n]||[],b[n].push(l))}a=i.length;if(1<a){for(j=0;j<a;j++)l=i[j],b=l.transform,k=l.mesh.bbox.center()._data,
k=mat4.multiplyVec4(b,quat4.create([k[0],k[1],k[2],1])),k=mat4.multiplyVec4(f.view,quat4.create([k[0],k[1],k[2],1])),i[j]=[l,k[3]];h?i.sort(function(a,b){return a[1]-b[1]}):i.sort(function(a,b){return b[1]-a[1]});for(j=0;j<a;j++)c[j]=i[j][0]}else 1==a&&(c[0]=i[0])};var a=mat4.create(),c=mat4.create();XML3D.webgl.Renderer.prototype.drawObjects=function(b,e,g,f,h){var i=0,j=0,k={};k["lightPositions[0]"]=f.positions;k["lightVisibility[0]"]=f.visible;k["lightDiffuseColors[0]"]=f.diffuseColors;k["lightAmbientColors[0]"]=
f.ambientColors;k["lightAttenuations[0]"]=f.attenuations;e=e||b[0].shader||"defaultShader";e=this.shaderManager.getShaderById(e);this.shaderManager.bindShader(e);this.shaderManager.updateShader(e);for(var f=0,l=b.length;f<l;f++){var n=b[f],o=n.mesh;n.visible&&o.valid&&(g.model=n.transform,g.modelView=mat4.multiply(this.camera.viewMatrix,g.model,a),k.modelMatrix=g.model,k.modelViewMatrix=g.modelView,k.modelViewProjectionMatrix=mat4.multiply(this.camera.projMatrix,g.modelView,c),k.normalMatrix=this.camera.getNormalMatrix(g.modelView),
this.shaderManager.setUniformVariables(e,k),j+=this.drawObject(e,o),i++)}h.objCount+=i;h.triCount+=j};XML3D.webgl.Renderer.prototype.drawObject=function(a,b){for(var c=a.attributes,f=this.handler.gl,h=0,i=b.vbos,j=b.isIndexed?i.index.length:i.position.length,k=0;k<j;k++){for(var l in c){var n=c[l];i[l]?(h=1<i[l].length?i[l][k]:i[l][0],f.enableVertexAttribArray(n.location),f.bindBuffer(f.ARRAY_BUFFER,h),f.vertexAttribPointer(n.location,h.tupleSize,h.glType,!1,0,0)):XML3D.debug.logWarning("Missing required mesh data [ "+
l+" ], the object may not render correctly.")}if(b.isIndexed){f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,i.index[k]);if(b.segments)for(var n=0,h=b.segments.value,o=0;o<h.length;o++)f.drawElements(b.glType,h[o],f.UNSIGNED_SHORT,n),n+=2*h[o];else f.drawElements(b.glType,i.index[k].length,f.UNSIGNED_SHORT,0);h=i.index[k].length/3}else{if(b.size){n=0;h=b.size.data;for(o=0;o<h.length;o++)f.drawArrays(b.glType,n,h[o]),n+=2*h[o]}else f.drawArrays(b.glType,0,i.position[k].length);h=i.position[k].length/3}for(l in c)n=
c[l],f.disableVertexAttribArray(n.location)}f.bindBuffer(f.ARRAY_BUFFER,null);f.bindBuffer(f.ELEMENT_ARRAY_BUFFER,null);return h};XML3D.webgl.Renderer.prototype.renderPickingPass=function(a,b,c){if(!(0>a||0>b||a>=this.width||b>=this.height)){var f=this.handler.gl;f.bindFramebuffer(f.FRAMEBUFFER,this.fbos.picking.handle);f.enable(f.DEPTH_TEST);f.disable(f.CULL_FACE);f.disable(f.BLEND);if(c){var h=(new window.XML3DVec3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE))._data,i=(new window.XML3DVec3(Number.MAX_VALUE,
Number.MAX_VALUE,Number.MAX_VALUE))._data;f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT|f.STENCIL_BUFFER_BIT);var j;this.camera.getProjectionMatrix(this.width/this.height);for(c=0;c<this.drawableObjects.length;c++){var k=this.drawableObjects[c];this.adjustMinMax(k.mesh.bbox,i,h,k.transform)}this.bbMin=i;this.bbMax=h;c=this.shaderManager.getShaderById("picking");this.shaderManager.bindShader(c);for(var h={min:i,max:h},i=0,l=this.drawableObjects.length;i<l;i++){var k=this.drawableObjects[i],n=k.transform,
k=k.mesh;!1!=k.isValid&&(j=n,j=this.camera.getModelViewMatrix(j),h.id=1-(1+i)/255,h.modelMatrix=n,h.modelViewProjectionMatrix=this.camera.getModelViewProjectionMatrix(j),this.shaderManager.setUniformVariables(c,h),this.drawObject(c,k))}this.shaderManager.unbindShader(c)}this.readPixels(!1,a,b);f.disable(f.DEPTH_TEST);f.bindFramebuffer(f.FRAMEBUFFER,null)}};XML3D.webgl.Renderer.prototype.renderPickedNormals=function(a,b,c){var f=this.handler.gl;f.bindFramebuffer(f.FRAMEBUFFER,this.fbos.picking.handle);
f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT|f.STENCIL_BUFFER_BIT);f.enable(f.DEPTH_TEST);f.disable(f.CULL_FACE);f.disable(f.BLEND);var h=a.transform,a=a.mesh,i=this.shaderManager.getShaderById("pickedNormals");this.shaderManager.bindShader(i);var j;j=this.camera.getModelViewMatrix(h);h={modelViewMatrix:h,modelViewProjectionMatrix:this.camera.getModelViewProjectionMatrix(j),normalMatrix:this.camera.getNormalMatrix(j)};this.shaderManager.setUniformVariables(i,h);this.drawObject(i,a);this.shaderManager.unbindShader(i);
this.readPixels(!0,b,c);f.bindFramebuffer(f.FRAMEBUFFER,null);this.handler.needPickingDraw=!0};XML3D.webgl.Renderer.prototype.readPixels=function(a,b,c){var f=new Uint8Array(8),h=this.fbos.picking.scale,i=this.handler.gl;try{i.readPixels(b*h,c*h,1,1,i.RGBA,i.UNSIGNED_BYTE,f);var j=vec3.create();j[0]=f[0]/255;j[1]=f[1]/255;j[2]=f[2]/255;if(a)j=vec3.subtract(vec3.scale(j,2),vec3.create([1,1,1])),this.xml3dNode.currentPickNormal=j;else{var k=255-f[3]-1;if(0<=k&&0<f[3]){var l=vec3.subtract(this.bbMax,
this.bbMin,vec3.create()),j=vec3.create([j[0]*l[0],j[1]*l[1],j[2]*l[2]]);vec3.add(j,this.bbMin,j);var n=this.drawableObjects[k];this.xml3dNode.currentPickPos=j;this.xml3dNode.currentPickObj=n.meshNode}else this.xml3dNode.currentPickPos=null,this.xml3dNode.currentPickObj=null}}catch(o){XML3D.debug.logError(o)}};XML3D.webgl.Renderer.prototype.adjustMinMax=function(a,b,c,f){var h=vec3.create(),i=vec3.create();mat4.multiplyVec3(f,a.min._data,h);mat4.multiplyVec3(f,a.max._data,i);h[0]<b[0]&&(b[0]=h[0]);
h[1]<b[1]&&(b[1]=h[1]);h[2]<b[2]&&(b[2]=h[2]);i[0]>c[0]&&(c[0]=i[0]);i[1]>c[1]&&(c[1]=i[1]);i[2]>c[2]&&(c[2]=i[2])};XML3D.webgl.Renderer.prototype.dispose=function(){for(var a=0,b=this.drawableObjects.length;a<b;a++){var c=this.drawableObjects[a][2];this.drawableObjects[a][1].dispose();c&&c.dispose()}};XML3D.webgl.Renderer.prototype.notifyDataChanged=function(){this.handler.redraw("Unspecified data change.")};XML3D.webgl.RenderAdapter=function(a,b){XML3D.data.Adapter.call(this,a,b)};XML3D.webgl.RenderAdapter.prototype=
new XML3D.data.Adapter;XML3D.webgl.RenderAdapter.prototype.constructor=XML3D.webgl.RenderAdapter;XML3D.webgl.RenderAdapter.prototype.isAdapterFor=function(a){return a==XML3D.webgl.Renderer.prototype};XML3D.webgl.RenderAdapter.prototype.getShader=function(){return null};XML3D.webgl.RenderAdapter.prototype.applyTransformMatrix=function(a){return a};XML3D.webgl.XML3DDefsRenderAdapter=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b)};XML3D.webgl.XML3DDefsRenderAdapter.prototype=new XML3D.webgl.RenderAdapter;
XML3D.webgl.XML3DDefsRenderAdapter.prototype.constructor=XML3D.webgl.XML3DDefsRenderAdapter;XML3D.webgl.XML3DDefsRenderAdapter.prototype.notifyChanged=function(){};XML3D.webgl.XML3DImgRenderAdapter=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.textureAdapter=a.getAdapter(b.parentNode)};XML3D.webgl.XML3DImgRenderAdapter.prototype=new XML3D.webgl.RenderAdapter;XML3D.webgl.XML3DImgRenderAdapter.prototype.constructor=XML3D.webgl.XML3DImgRenderAdapter;XML3D.webgl.XML3DImgRenderAdapter.prototype.notifyChanged=
function(a){this.textureAdapter.notifyChanged(a)};XML3D.webgl.XML3DLightShaderRenderAdapter=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b)};XML3D.webgl.XML3DLightShaderRenderAdapter.prototype=new XML3D.webgl.RenderAdapter;XML3D.webgl.XML3DLightShaderRenderAdapter.prototype.constructor=XML3D.webgl.XML3DLightShaderRenderAdapter})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.factory=a;this.processListeners()};XML3D.createClass(b,XML3D.webgl.RenderAdapter);b.prototype.notifyChanged=function(a){0==a.type?this.factory.renderer.sceneTreeAddition(a):2==a.type&&this.factory.renderer.sceneTreeRemoval(a);"activeView"==(a.internalType||a.attrName||a.wrapped.attrName)&&this.factory.renderer.activeViewChanged()};b.prototype.processListeners=function(){var a=this.node.attributes,b;for(b in a){var d=a[b];
if(d.name){var e=d.name;(e.match(/onmouse/)||"onclick"==e||"ondblclick"==e)&&this.node.addEventListener(e.substring(2),new Function("evt",d.value),!1)}}};b.prototype.getElementByPoint=function(a,b,d,e){this.factory.handler.renderPick(a,b);d&&this.node.currentPickPos&&XML3D.copyVector(d,this.node.currentPickPos);e&&this.node.currentPickObj&&(this.factory.handler.renderPickedNormals(this.node.currentPickObj,a,b),XML3D.copyVector(e,this.node.currentPickNormal));return this.node.currentPickObj?this.node.currentPickObj:
null};b.prototype.generateRay=function(a,b){var d=this.factory.handler.getCanvasHeight()-b-1;return this.factory.handler.generateRay(a,d)};XML3D.webgl.XML3DCanvasRenderAdapter=b})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.matrix=null;this.isValid=!0};XML3D.createClass(b,XML3D.webgl.RenderAdapter);var a=b.prototype;a.getMatrix=function(){if(!this.matrix){var a=this.node,b=mat4.identity(mat4.create()),e=a.translation._data,g=a.center._data,f=a.scale._data,h=a.scaleOrientation.toMatrix()._data,a=a.rotation.toMatrix()._data;this.matrix=mat4.multiply(mat4.multiply(mat4.multiply(mat4.multiply(mat4.multiply(mat4.multiply(mat4.translate(b,e,mat4.create()),
mat4.translate(b,g,mat4.create())),a),h),mat4.scale(b,f,mat4.create())),mat4.inverse(h,mat4.create())),mat4.translate(b,vec3.negate(g),mat4.create()))}return this.matrix};a.notifyChanged=function(a){1==a.type?(this.matrix=null,this.matrix=this.getMatrix(),this.factory.renderer.requestRedraw("Transformation changed.",!0)):2==a.type&&this.dispose();var b=this.node._configured.opposites;if(b)for(var e=0,g=b.length;e<g;e++){var f=this.factory.getAdapter(b[e].relatedNode);f&&f.notifyChanged&&f.notifyChanged(a)}};
a.dispose=function(){this.isValid=!1};XML3D.webgl.XML3DTransformRenderAdapter=b})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.zFar=1E5;this.zNear=0.1;this.projMatrix=this.viewMatrix=this.parentTransform=null;this.updateViewMatrix()};XML3D.createClass(b,XML3D.webgl.RenderAdapter);var a=b.prototype;a.updateViewMatrix=function(){var a=this.node.position._data,b=this.node.orientation,a=mat4.multiply(mat4.translate(mat4.identity(mat4.create()),a),b.toMatrix()._data);(this.parentTransform=this.factory.getAdapter(this.node.parentNode).applyTransformMatrix(mat4.identity(mat4.create())))&&
(a=mat4.multiply(this.parentTransform,a,mat4.create()));this.viewMatrix=mat4.inverse(a)};a.getProjectionMatrix=function(a){if(null==this.projMatrix){var b=this.zFar,e=this.zNear,g=1/Math.tan(this.node.fieldOfView/2);this.projMatrix=mat4.create([g/a,0,0,0,0,g,0,0,0,0,(e+b)/(e-b),-1,0,0,2*e*b/(e-b),0])}return this.projMatrix};a.getViewMatrix=function(){var a=new window.XML3DMatrix;a._data.set(this.viewMatrix);return a};a.getModelViewMatrix=function(a){return mat4.multiply(this.viewMatrix,a,mat4.create())};
a.getNormalMatrix=function(a){return mat3.transpose(mat4.toInverseMat3(a))};a.getModelViewProjectionMatrix=function(a){return mat4.multiply(this.projMatrix,a,mat4.create())};a.notifyChanged=function(a){var b=a.internalType||a.attrName||a.wrapped.attrName;switch(b){case "parenttransform":this.parentTransform=a.newValue;this.updateViewMatrix();break;case "orientation":case "position":this.updateViewMatrix();break;case "fieldOfView":this.projMatrix=null;break;default:XML3D.debug.logWarning("Unhandled event in view adapter for parameter "+
b)}this.factory.handler.redraw("View changed")};XML3D.webgl.XML3DViewRenderAdapter=b})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.renderer=this.factory.renderer;this.dataAdapter=this.renderer.dataFactory.getAdapter(this.node)};XML3D.createClass(b,XML3D.webgl.RenderAdapter);var a=b.prototype;a.notifyChanged=function(a){if(0==a.type)this.factory.renderer.sceneTreeAddition(a);else if(2==a.type)this.factory.renderer.sceneTreeRemoval(a);else if(5==a.type){var b=a.wrapped.target;b&&"texture"==b.nodeName&&this.renderer.recompileShader(this)}else switch(b=
a.internalType||a.attrName||a.wrapped.attrName,b){case "script":this.renderer.recompileShader(this);break;case "src":var e=a.wrapped.relatedNode;e.ownerElement&&(e=e.ownerElement);e=e.parentNode;this.renderer.shaderDataChanged(this.node.id,b,a.wrapped.newValue,e.name);break;default:XML3D.debug.logWarning("Unhandled mutation event in shader adapter for parameter '"+b+"'")}};a.requestData=function(a){return this.dataAdapter.requestOutputData(this,a)};a.notifyDataChanged=function(a){if(a.wrapped&&(a=
a.wrapped.currentTarget.name||a.wrapped.relatedNode.name)){var b=this.requestData([a])[a].value;2>b.length&&(b=b[0]);this.renderer.shaderDataChanged(this.node.id,a,b)}};a.destroy=function(){Array.forEach(this.textures,function(a){a.adapter.destroy()})};a.bindSamplers=function(){var a=!1,b;for(b in this.textures){var e=this.textures[b];if(null!=e.adapter.node)e.adapter.bind(e.info.texUnit);else{a=!0;break}}a&&(delete this.textures[b],this.destroy(),this.enable())};a.getXFlowShader=function(a,b){if(this.xflowBuilt)return this.program;
var e=this.program.vSource,g=this.program.fSource,e=a+e,f=e.indexOf("~"),h=e.substring(0,f+1),e=e.substring(f+3),f={};f.vs=h+"\n"+b+e;f.fs=g;this.xflowBuilt=!0;return this.createShaderProgram(f)};XML3D.webgl.XML3DShaderRenderAdapter=b})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.gl=a.renderer.handler.gl;this.factory=a;this.node=b;this.dataAdapter=a.renderer.dataFactory.getAdapter(this.node)};XML3D.createClass(b,XML3D.webgl.RenderAdapter);b.prototype.notifyChanged=function(a){var b=this.factory.getAdapter(this.node.parentElement);b&&b.notifyChanged(a)};b.prototype.getDataTable=function(){return this.dataAdapter.createDataTable()};b.prototype.destroy=function(){this.info&&null!==this.info.handle&&
(this.gl.deleteTexture(this.info.handle),this.info=null,this.bind=function(){},this.unbind=function(){})};b.prototype.dispose=function(){};XML3D.webgl.XML3DTextureRenderAdapter=b})();XML3D.webgl.MAX_MESH_INDEX_COUNT=65535;
(function(){var b=function(){XML3D.debug.logError("Mesh adapter has no callback to its mesh object!")},a=window.WebGLRenderingContext,c=function(a,c){XML3D.webgl.RenderAdapter.call(this,a,c);this.processListeners();this.dataAdapter=a.renderer.dataFactory.getAdapter(this.node);this.parentVisible=!0;this.getMyDrawableObject=b};XML3D.createClass(c,XML3D.webgl.RenderAdapter);var d=c.prototype;d.processListeners=function(){var a=this.node.attributes,b;for(b in a){var c=a[b];if(c.name){var d=c.name;(d.match(/onmouse/)||
"onclick"==d||"ondblclick"==d)&&this.node.addEventListener(d.substring(2),new Function("evt",c.value),!1)}}};d.registerCallback=function(a){a instanceof Function&&(this.getMyDrawableObject=a)};d.notifyChanged=function(a){if(0!=a.type){if(2==a.type)return this.factory.renderer.sceneTreeRemoval(a);var b=a.internalType||a.attrName||a.wrapped.attrName;switch(b){case "parenttransform":this.getMyDrawableObject().transform=a.newValue;break;case "parentshader":a=a.newValue?a.newValue.node.id:"defaultShader";
this.getMyDrawableObject().shader=a;break;case "parentvisible":this.getMyDrawableObject().visible=a.newValue&&this.node.visible;break;case "visible":this.getMyDrawableObject().visible="true"==a.wrapped.newValue&&this.node.parentNode.visible;break;case "src":this.dispose(a);this.createMesh();break;case "type":a=this.getGLTypeFromString(a.wrapped.newValue);this.getMyDrawableObject().mesh.glType=a;break;default:XML3D.debug.logWarning("Unhandled mutation event in mesh adapter for parameter '"+b+"'")}}};
d.notifyDataChanged=function(){};var e=function(b){return b instanceof Int8Array?a.BYTE:b instanceof Uint8Array?a.UNSIGNED_BYTE:b instanceof Int16Array?a.SHORT:b instanceof Uint16Array?a.UNSIGNED_SHORT:b instanceof Int32Array?a.INT:b instanceof Uint32Array?a.UNSIGNED_INT:a.FLOAT},g=function(a,b,c){var d=a.createBuffer();a.bindBuffer(b,d);a.bufferData(b,c,a.STATIC_DRAW);d.length=c.length;d.glType=e(c);return d};d.createMesh=function(){this.dataAdapter.requestOutputData(this,"index,position,normal,color,texcoord,size".split(","),
null,this.dataChanged)};d.dataChanged=function(a,b){var b=b||-1,c=this.factory.renderer.getGLContext(),d=this.getMyDrawableObject(),k;if(!a.position||!(k=a.position.getValue()))XML3D.debug.logError("Mesh "+this.node.id+" has no data for required attribute 'position'."),d.mesh={vbos:{},glType:0,valid:!1};else{this.bbox=XML3D.webgl.calculateBoundingBox(k,a.index.getValue());var l={vbos:{},glType:this.getGLTypeFromString(this.node.type)};if(a.index)if(k.length/3>XML3D.webgl.MAX_MESH_INDEX_COUNT&&XML3D.webgl.splitMesh(a,
XML3D.webgl.MAX_MESH_INDEX_COUNT),0<a.index.length){var n=a.index.length;l.vbos.index=[];for(k=0;k<n;k++){var o=new Uint16Array(a.index[k].data),m=c.createBuffer();c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,m);c.bufferData(c.ELEMENT_ARRAY_BUFFER,o,c.STATIC_DRAW);m.length=o.length;m.tupleSize=a.index[k].tupleSize;m.glType=e(o);l.vbos.index[k]=m;l.isIndexed=!0}}else{m=a.index.data.buffer;if(!m||-1==b||b==a.index)m=g(c,c.ELEMENT_ARRAY_BUFFER,new Uint16Array(a.index.getValue())),m.tupleSize=a.index.getTupleSize(),
a.index.data.buffer=m;l.vbos.index=[];l.vbos.index[0]=m;l.isIndexed=!0}else l.isIndexed=!1;for(var p in a)if(n=a[p],!n.isXflow&&!("xflowShader"==p||"index"==p||"segments"==p))if(0<n.length){o=n.length;l.vbos[p]=[];for(k=0;k<o;k++)m=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,m),c.bufferData(c.ARRAY_BUFFER,n[k].value,c.STATIC_DRAW),m.length=n[k].value.length,m.tupleSize=n[k].tupleSize,m.glType=e(n[k].value),l.vbos[p][k]=m}else m=n.data.buffer,!m||-1==b?(k=n.getValue(),m=g(c,c.ARRAY_BUFFER,k),m.tupleSize=
n.getTupleSize(),n.data.buffer=m):b==n&&(c.bindBuffer(c.ARRAY_BUFFER,m),c.bufferData(c.ARRAY_BUFFER,n.getValue(),c.DYNAMIC_DRAW)),l.vbos[p]=[],l.vbos[p][0]=m;l.valid=!0;l.bbox=XML3D.webgl.calculateBoundingBox(a.position.data,a.index?a.index.data:null);a.size&&(l.segments=a.size);d.mesh=l;this.factory.renderer.requestRedraw("Mesh data changed.",!1)}};d.dispose=function(a){a||(a=this.factory.renderer.getGLContext());var b=this.getMyDrawableObject(),c=b.mesh.vbos,d;for(d in c)for(var e=c[d],g=0;g<e.length;g++)a.deleteBuffer(e[g]);
b.mesh.valid=!1};d.destroy=function(a){a||(a=this.factory.renderer.getGLContext());this.getMyDrawableObject!=b&&(this.dispose(a),this.factory.renderer.removeDrawableObject(this.getMyDrawableObject()),this.getMyDrawableObject=b)};d.getBoundingBox=function(){return this.bbox};d.getGLTypeFromString=function(b){b&&b.toLowerCase&&(b=b.toLowerCase());switch(b){case "triangles":return a.TRIANGLES;case "tristrips":return a.TRIANGLE_STRIP;case "points":return a.POINTS;case "lines":return a.LINES;case "linestrips":return a.LINE_STRIP;
default:return a.TRIANGLES}};XML3D.webgl.XML3DMeshRenderAdapter=c})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);this.processListeners();this.factory=a;this.parentShader=this.parentTransform=null;this.isValid=this.parentVisible=!0;this.updateTransformAdapter()};XML3D.createClass(b,XML3D.webgl.RenderAdapter);var a=b.prototype;a.applyTransformMatrix=function(a){null!==this.parentTransform&&(a=mat4.multiply(this.parentTransform,a,mat4.create()));this.transformAdapter&&(a=mat4.multiply(a,this.transformAdapter.getMatrix(),mat4.create()));return a};
a.updateTransformAdapter=function(){this.transformAdapter=null;var a=this.node.transform;if(a&&(a=XML3D.URIResolver.resolve(a)))this.transformAdapter=this.factory.getAdapter(a)};a.processListeners=function(){var a=this.node.attributes,b;for(b in a){var e=a[b];if(e.name){var g=e.name;(g.match(/onmouse/)||"onclick"==g||"ondblclick"==g)&&this.node.addEventListener(g.substring(2),new Function("evt",e.value),!1)}}};a.notifyChanged=function(a){if(0==a.type)this.factory.renderer.sceneTreeAddition(a);else if(2==
a.type)this.factory.renderer.sceneTreeRemoval(a);else if(5!=a.type){var b=a.internalType||a.attrName||a.wrapped.attrName;switch(b){case "shader":b=this.getShader();b||(b=this.parentShader);a.internalType="parentshader";a.newValue=b;this.notifyChildren(a);this.factory.renderer.requestRedraw("Group shader changed.",!1);break;case "parentshader":this.parentShader=null;this.getShader()||this.notifyChildren(a);this.parentShader=a.newValue;break;case "translation":case "rotation":case "scale":b=this.transformAdapter.getMatrix();
this.parentTransform&&(b=mat4.multiply(this.parentTransform,b,mat4.create()));a.internalType="parenttransform";a.newValue=b;this.notifyChildren(a);delete a.internalType;delete a.newValue;break;case "transform":this.updateTransformAdapter(this);b=this.transformAdapter?this.transformAdapter.getMatrix():this.parentTransform?mat4.identity(mat4.create()):null;this.parentTransform&&(b=mat4.multiply(this.parentTransform,b,mat4.create()));a.internalType="parenttransform";a.newValue=b;this.notifyChildren(a);
delete a.internalType;delete a.newValue;this.factory.renderer.requestRedraw("Group transform changed.",!0);break;case "parenttransform":var e=b=a.newValue;this.parentTransform=a.newValue;this.transformAdapter&&(b=mat4.multiply(e,this.transformAdapter.getMatrix(),mat4.create()));a.newValue=b;this.notifyChildren(a);a.newValue=e;break;case "visible":if(!1==this.parentVisible)break;else a.internalType="parentvisible",a.newValue="true"==a.wrapped.newValue,this.notifyChildren(a),delete a.internalType,delete a.newValue,
this.factory.renderer.requestRedraw("Group visibility changed.",!0);break;case "parentvisible":this.parentVisible=a.newValue;if(!1==this.node.visible)break;else this.notifyChildren(a);break;default:XML3D.debug.logWarning("Unhandled mutation event in group adapter for parameter '"+b+"'")}}};a.notifyChildren=function(a){for(var b=this.node.firstElementChild;b;)this.factory.getAdapter(b).notifyChanged(a),b=b.nextElementSibling};a.getShader=function(){var a=this.node.shader;if(""==a){var b=this.node.getAttribute("style");
b&&(b=/shader\s*:\s*url\s*\(\s*(\S+)\s*\)/i.exec(b))&&(a=XML3D.URIResolver.resolve(b[1]))}else a=XML3D.URIResolver.resolve(a);return(a=this.factory.getAdapter(a))||this.parentShader};a.destroy=function(){for(var a=this.node.firstElementChild;a;){var b=this.factory.getAdapter(a);b&&b.destroy&&b.destroy();a=a.nextElementSibling}this.isValid=!1};a.getBoundingBox=function(){var a=new window.XML3DBox;Array.prototype.forEach.call(this.node.childNodes,function(b){b.getBoundingBox&&a.extend(b.getBoundingBox())});
this.transformAdapter&&XML3D.webgl.transformAABB(a,this.transformAdapter.getMatrix());return a};a.getLocalMatrix=function(){var a=new window.XML3DMatrix;null!==this.transformAdapter&&a._data.set(this.transformAdapter.getMatrix());return a};a.getWorldMatrix=function(){var a=new window.XML3DMatrix;this.parentTransform&&a._data.set(this.parentTransform);this.transformAdapter&&mat4.multiply(a._data,this.transformAdapter.getMatrix());return a};XML3D.webgl.XML3DGroupRenderAdapter=b})();(function(){var b=function(a,b){XML3D.webgl.RenderAdapter.call(this,a,b);var d=b.getAttribute("intensity");if(d)try{this.intensity=parseFloat(d)}catch(e){XML3D.debug.logWarning("Could not parse light intensity attribute ' "+d+" '")}this.visible=!0;this.lightShader=this.transform=this.intensity=this.position=null;this.isValid=!0};XML3D.createClass(b,XML3D.webgl.RenderAdapter);b.prototype.notifyChanged=function(a){switch(a.internalType||a.wrapped.attrName){case "visible":this.visible="true"==a.wrapped.newValue&&
this.node.parentNode.visible;break;case "parentvisible":this.visible=a.newValue&&this.node.visible;break;case "intensity":isNaN(a.newValue)?XML3D.debug.logError("Invalid parameter for light intensity attribute: NaN"):this.intensity=a.newValue;break;case "parenttransform":this.transform=a.newValue}this.factory.handler.redraw("Light attribute changed.")};b.prototype.requestData=function(a,b){var d=this.getLightShader();if(!d)return null;var e=mat4.create(b);this.transform&&(e=mat4.multiply(e,this.transform,
mat4.create()));this.dataAdapter||(this.dataAdapter=d.factory.renderer.dataFactory.getAdapter(d.node));var d=this.dataAdapter.requestOutputData(this,a),g=this.visible?[1,1,1]:[0,0,0],f=mat4.multiplyVec4(e,quat4.create([0,0,0,1])),g={position:[f[0]/f[3],f[1]/f[3],f[2]/f[3]],attenuation:[0,0,1],intensity:[1,1,1],visibility:g},h;for(h in d)"position"==h?(f=quat4.create([d[h].value[0],d[h].value[1],d[h].value[2],1]),mat4.multiplyVec4(e,f),g[h]=[f[0]/f[3],f[1]/f[3],f[2]/f[3]]):g[h]=d[h].value;null!==this.intensity&&
(e=g.intensity,g.intensity=[e[0]*this.intensity,e[1]*this.intensity,e[2]*this.intensity]);return g};b.prototype.getLightShader=function(){if(!this.lightShader){var a=this.node.shader,b=null;""!=a&&(b=XML3D.URIResolver.resolve(a));if(null==b){a=this.node.getAttribute("style");if(!a)return null;(a=/shader\s*:\s*url\s*\(\s*(\S+)\s*\)/i.exec(a))&&(b=this.node.xml3ddocument.resolve(a[1]))}this.lightShader=this.factory.getAdapter(b)}return this.lightShader};b.prototype.dispose=function(){this.isValid=!1};
XML3D.webgl.XML3DLightRenderAdapter=b})();(function(){var b=function(a,b){XML3D.data.AdapterFactory.call(this);this.handler=a;this.renderer=b;this.name="XML3DRenderAdapterFactory"};XML3D.createClass(b,XML3D.data.AdapterFactory);var a=XML3D.webgl,c={xml3d:a.XML3DCanvasRenderAdapter,view:a.XML3DViewRenderAdapter,defs:a.XML3DDefsRenderAdapter,mesh:a.XML3DMeshRenderAdapter,transform:a.XML3DTransformRenderAdapter,shader:a.XML3DShaderRenderAdapter,texture:a.XML3DTextureRenderAdapter,group:a.XML3DGroupRenderAdapter,img:a.XML3DImgRenderAdapter,light:a.XML3DLightRenderAdapter,
lightshader:a.XML3DLightShaderRenderAdapter};b.prototype.createAdapter=function(a){var b=c[a.localName];return void 0!==b?new b(this,a):null};XML3D.webgl.XML3DRenderAdapterFactory=b})();var g_shaders={};g_shaders["urn:xml3d:shader:matte"]=g_shaders["urn:xml3d:shader:flat"]={vertex:"attribute vec3 position;uniform mat4 modelViewProjectionMatrix;void main(void) {    vec3 pos = position;\n\n //~    \ngl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nuniform vec3 diffuseColor;void main(void) {\n    gl_FragColor = vec4(diffuseColor.x, diffuseColor.y, diffuseColor.z, 1.0);}"};
g_shaders["urn:xml3d:shader:mattevcolor"]=g_shaders["urn:xml3d:shader:flatvcolor"]={vertex:"attribute vec3 position;attribute vec3 color;varying vec3 fragVertexColor;uniform mat4 modelViewProjectionMatrix;void main(void) {    vec3 pos = position;\n\n //~    \nfragVertexColor = color;    gl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nuniform vec3 diffuseColor;varying vec3 fragVertexColor;void main(void) {    gl_FragColor = vec4(fragVertexColor, 1.0);}"};
g_shaders["urn:xml3d:shader:diffuse"]={vertex:"attribute vec3 position;\nattribute vec3 normal;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal;\n\n //~\t  \ngl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n\t  fragNormal = normalize(normalMatrix * norm);\n\t  fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n\t  fragEyeVector = normalize(fragVertexPosition);\n}\n",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n// const int MAXLIGHTS = 0; \nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nuniform vec3 lightAttenuations[MAXLIGHTS+1];\nuniform vec3 lightPositions[MAXLIGHTS+1];\nuniform vec3 lightDiffuseColors[MAXLIGHTS+1];\nuniform vec3 lightVisibility[MAXLIGHTS+1];\nvoid main(void) {\n  vec3 color = emissiveColor;\n\tif (MAXLIGHTS < 1) {\n      vec3 normal = fragNormal;\n      vec3 eye = fragEyeVector;\n      float diffuse = max(0.0, dot(normal, -eye)) ;\n      diffuse += max(0.0, dot(normal, eye));\n      color = color + diffuse*diffuseColor;\n\t} else {\n\t\tfor (int i=0; i<MAXLIGHTS; i++) {\n\t\t\tvec3 L = lightPositions[i] - fragVertexPosition;\n      \tvec3 N = fragNormal;\n\t\t\tfloat dist = length(L);\n      \tL = normalize(L);\n\t\t\tfloat atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n\t\t\tvec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * diffuseColor ;\n\t\t\tcolor = color + (atten*Idiff) * lightVisibility[i];\n\t\t}\n  }\n\tgl_FragColor = vec4(color, 1.0);\n}"};
g_shaders["urn:xml3d:shader:textureddiffuse"]={vertex:"attribute vec2 texcoord;\nattribute vec3 position;\nattribute vec3 normal;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec2 tex = texcoord;\n    vec3 pos = position;\n    vec3 norm = normal;\n\n //~\t  \ngl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n\t  fragNormal = normalize(normalMatrix * norm);\n\t  fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n\t  fragEyeVector = normalize(fragVertexPosition);\n    fragTexCoord = tex;\n}\n",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n// const int MAXLIGHTS = 0; \nuniform vec3 diffuseColor;\nuniform sampler2D diffuseTexture;uniform vec3 emissiveColor;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nuniform vec3 lightAttenuations[MAXLIGHTS+1];\nuniform vec3 lightPositions[MAXLIGHTS+1];\nuniform vec3 lightDiffuseColors[MAXLIGHTS+1];\nuniform vec3 lightVisibility[MAXLIGHTS+1];\nvoid main(void) {\n  vec3 color = emissiveColor;\n\tif (MAXLIGHTS < 1) {\n      vec3 normal = fragNormal;\n      vec3 eye = fragEyeVector;\n      float diffuse = max(0.0, dot(normal, -eye)) ;\n      diffuse += max(0.0, dot(normal, eye));\n      color = color + diffuse*texture2D(diffuseTexture, fragTexCoord).xyz;\n\t} else {\n      vec4 texDiffuse = texture2D(diffuseTexture, fragTexCoord);\n\t\tfor (int i=0; i<MAXLIGHTS; i++) {\n\t\t\tvec3 L = lightPositions[i] - fragVertexPosition;\n      \tvec3 N = fragNormal;\n\t\t\tfloat dist = length(L);\n      \tL = normalize(L);\n\t\t\tfloat atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n\t\t\tvec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * texDiffuse.xyz;\n\t\t\tcolor = color + (atten*Idiff) * lightVisibility[i];\n\t\t}\n  }\n\tgl_FragColor = vec4(color, 1.0);\n}"};
g_shaders["urn:xml3d:shader:diffusevcolor"]={vertex:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec3 color;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal;\n\n //~\t  \ngl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n\t  fragNormal = normalize(normalMatrix * norm);\n\t  fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n\t  fragEyeVector = normalize(fragVertexPosition);\n\t  fragVertexColor = color;\n}\n",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n// const int MAXLIGHTS = 0; \nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec3 fragVertexColor;\nuniform vec3 lightAttenuations[MAXLIGHTS+1];\nuniform vec3 lightPositions[MAXLIGHTS+1];\nuniform vec3 lightDiffuseColors[MAXLIGHTS+1];\nuniform vec3 lightVisibility[MAXLIGHTS+1];\nvoid main(void) {\n  vec3 color = emissiveColor;\n\tif (MAXLIGHTS < 1) {\n      vec3 normal = fragNormal;\n      vec3 eye = fragEyeVector;\n      float diffuse = max(0.0, dot(normal, -eye)) ;\n      diffuse += max(0.0, dot(normal, eye));\n      color = color + diffuse*fragVertexColor;\n\t} else {\n\t\tfor (int i=0; i<MAXLIGHTS; i++) {\n\t\t\tvec3 L = lightPositions[i] - fragVertexPosition;\n      \tvec3 N = fragNormal;\n\t\t\tfloat dist = length(L);\n      \tL = normalize(L);\n\t\t\tfloat atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n\t\t\tvec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * fragVertexColor ;\n\t\t\tcolor = color + (atten*Idiff) * lightVisibility[i];\n\t\t}\n  }\n\tgl_FragColor = vec4(color, 1.0);\n}"};
g_shaders["urn:xml3d:shader:phong"]={vertex:"attribute vec3 position;\nattribute vec3 normal;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal;\n\n //~\t  \ngl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n\t  fragNormal = normalize(normalMatrix * norm);\n\t  fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n\t  fragEyeVector = normalize(fragVertexPosition);\n}\n",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n// Number of lights: MAXLIGHTS \nuniform float ambientIntensity;\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float shininess;\nuniform vec3 specularColor;\nuniform float transparency;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\n#if MAXLIGHTS > 0\nuniform vec3 lightAttenuations[MAXLIGHTS+1];\nuniform vec3 lightPositions[MAXLIGHTS+1];\nuniform vec3 lightDiffuseColors[MAXLIGHTS+1];\nuniform vec3 lightVisibility[MAXLIGHTS+1];\n#endif\nvoid main(void) {\n  if (transparency > 0.95) discard;\n  vec3 color = emissiveColor;\n#if MAXLIGHTS < 1\n  vec3 light = -normalize(fragVertexPosition);\n  vec3 normal = fragNormal;\n  vec3 eye = fragEyeVector;\n  vec3 lightEye = normalize(light-eye);\n  float diffuse = max(0.0, dot(normal, -eye)) ;\n  diffuse += max(0.0, dot(normal, eye));\n  float specular = pow(max(0.0, dot(normal, lightEye)), shininess*128.0);\n  specular += pow(max(0.0, dot(normal, -lightEye)), shininess*128.0);\n  color = color + diffuse*diffuseColor + specular*specularColor;\n#else\n  for (int i=0; i<MAXLIGHTS; i++) {\n    vec3 L = lightPositions[i] - fragVertexPosition;\n    vec3 N = fragNormal;\n    vec3 E = fragEyeVector;\n    float dist = length(L);\n    L = normalize(L);\n    vec3 R = normalize(reflect(L,N));\n    float atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n    vec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * diffuseColor ;\n    vec3 Ispec = specularColor * pow(max(dot(R,E),0.0), shininess*128.0) * lightDiffuseColors[i];\n    color = color + (atten*(Idiff + Ispec)) * lightVisibility[i];\n  }\n#endif\n  gl_FragColor = vec4(color, max(0.0, 1.0 - transparency));\n}"};
g_shaders["urn:xml3d:shader:texturedphong"]={vertex:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec2 texcoord;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec2 tex = texcoord;\n    vec3 pos = position;\n    vec3 norm = normal;\n\n //~\t  \ngl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n\t  fragNormal = normalize(normalMatrix * norm);\n\t  fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n\t  fragEyeVector = normalize(fragVertexPosition);\n    fragTexCoord = tex;\n}\n",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n// const int MAXLIGHTS = 0; \nuniform float ambientIntensity;\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float shininess;\nuniform vec3 specularColor;\nuniform float transparency;\nuniform float lightOn;\nuniform sampler2D diffuseTexture;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec2 fragTexCoord;\n#if MAXLIGHTS > 0\nuniform vec3 lightAttenuations[MAXLIGHTS+1];\nuniform vec3 lightPositions[MAXLIGHTS+1];\nuniform vec3 lightDiffuseColors[MAXLIGHTS+1];\nuniform vec3 lightVisibility[MAXLIGHTS+1];\n#endif\nvoid main(void) {\n  vec4 color = vec4(emissiveColor, 0.0);\n#if MAXLIGHTS < 1\n      vec3 light = -normalize(fragVertexPosition);\n      vec3 normal = fragNormal;\n      vec3 eye = fragEyeVector;\n      vec3 lightEye = normalize(light-eye);\n      float diffuse = max(0.0, dot(normal, -eye)) ;\n      diffuse += max(0.0, dot(normal, eye));\n      float specular = pow(max(0.0, dot(normal, lightEye)), shininess*128.0);\n      specular += pow(max(0.0, dot(normal, -lightEye)), shininess*128.0);\n      vec4 texDiffuse = texture2D(diffuseTexture, fragTexCoord);\n      color += vec4(diffuse*texDiffuse.xyz+ specular*specularColor, texDiffuse.w);\n#else\n      vec4 texDiffuse = texture2D(diffuseTexture, fragTexCoord);\n\t\tfor (int i=0; i<MAXLIGHTS; i++) {\n\t\t\tvec3 L = lightPositions[i] - fragVertexPosition;\n      \tvec3 N = fragNormal;\n\t\t\tvec3 E = fragEyeVector;\n\t\t\tfloat dist = length(L);\n     \t \tL = normalize(L);\n\t\t\tvec3 R = normalize(reflect(L,N));\n\t\t\tfloat atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n\t\t\tvec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * texDiffuse.xyz * diffuseColor;\n\t\t\tvec3 Ispec = specularColor * pow(max(dot(R,E),0.0), shininess*128.0) * lightDiffuseColors[i];\n\t\t\tcolor += vec4((atten*(Idiff + Ispec))*lightVisibility[i], texDiffuse.w);\n       }\n#endif\n  float alpha = color.w * max(0.0, 1.0 - transparency);\n  if (alpha < 0.05) discard;\n\tgl_FragColor = vec4(color.xyz, alpha);\n}"};
g_shaders["urn:xml3d:shader:phongvcolor"]={vertex:"attribute vec3 position;\nattribute vec3 normal;\nattribute vec3 color;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec3 fragVertexColor;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 eyePosition;\nvoid main(void) {\n    vec3 pos = position;\n    vec3 norm = normal;\n\n //~\t  \ngl_Position = modelViewProjectionMatrix * vec4(pos, 1.0);\n\t  fragNormal = normalize(normalMatrix * norm);\n\t  fragVertexPosition = (modelViewMatrix * vec4(pos, 1.0)).xyz;\n\t  fragEyeVector = normalize(fragVertexPosition);\n   fragVertexColor = color;\n}\n",
fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\n\n// const int MAXLIGHTS = 0; \nuniform float ambientIntensity;\nuniform vec3 diffuseColor;\nuniform vec3 emissiveColor;\nuniform float shininess;\nuniform vec3 specularColor;\nuniform float transparency;\nuniform float lightOn;\nvarying vec3 fragNormal;\nvarying vec3 fragVertexPosition;\nvarying vec3 fragEyeVector;\nvarying vec3 fragVertexColor;\n#if MAXLIGHTS > 0\nuniform vec3 lightAttenuations[MAXLIGHTS+1];\nuniform vec3 lightPositions[MAXLIGHTS+1];\nuniform vec3 lightDiffuseColors[MAXLIGHTS+1];\nuniform vec3 lightVisibility[MAXLIGHTS+1];\n#endif\nvoid main(void) {\n  if (transparency > 0.95) discard;\n  vec3 color = emissiveColor;\n#if MAXLIGHTS < 1\n      vec3 light = -normalize(fragVertexPosition);\n      vec3 normal = fragNormal;\n      vec3 eye = fragEyeVector;\n      vec3 lightEye = normalize(light-eye);\n      float diffuse = max(0.0, dot(normal, -eye)) ;\n      diffuse += max(0.0, dot(normal, eye));\n      float specular = pow(max(0.0, dot(normal, lightEye)), shininess*128.0);\n      specular += pow(max(0.0, dot(normal, -lightEye)), shininess*128.0);\n      color += diffuse*fragVertexColor + specular*specularColor;\n#else\n\t\tfor (int i=0; i<MAXLIGHTS; i++) {\n\t\t\tvec3 L = lightPositions[i] - fragVertexPosition;\n      \tvec3 N = fragNormal;\n\t\t\tvec3 E = fragEyeVector;\n\t\t\tfloat dist = length(L);\n      \tL = normalize(L);\n\t\t\tvec3 R = normalize(reflect(L,N));\n\t\t\tfloat atten = 1.0 / (lightAttenuations[i].x + lightAttenuations[i].y * dist + lightAttenuations[i].z * dist * dist);\n\t\t\tvec3 Idiff = lightDiffuseColors[i] * max(dot(N,L),0.0) * fragVertexColor ;\n\t\t\tvec3 Ispec = specularColor * pow(max(dot(R,E),0.0), shininess*128.0) * lightDiffuseColors[i];\n\t\t\tcolor += (atten*(Idiff + Ispec))*lightVisibility[i];\n      }\n#endif\n\tgl_FragColor = vec4(color, max(0.0, 1.0 - transparency));\n}"};
g_shaders["urn:xml3d:shader:picking"]={vertex:"attribute vec3 position;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform vec3 min;\nuniform vec3 max;\nvarying vec3 worldCoord;\nvoid main(void) {\n    worldCoord = (modelMatrix * vec4(position, 1.0)).xyz;\n    vec3 diff = max - min;\n    worldCoord = worldCoord - min;\n    worldCoord = worldCoord / diff;    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nuniform float id;varying vec3 worldCoord;\nvoid main(void) {\n    gl_FragColor = vec4(worldCoord, id);\n}\n"};
g_shaders["urn:xml3d:shader:pickedNormals"]={vertex:"attribute vec3 position;\nattribute vec3 normal;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelViewProjectionMatrix;\nuniform mat3 normalMatrix;\nvarying vec3 fragNormal;\nvoid main(void) {\n\t   fragNormal = normalize(normalMatrix * normal);\n    gl_Position = modelViewProjectionMatrix * vec4(position, 1.0);\n}",fragment:"#ifdef GL_ES\nprecision highp float;\n#endif\n\nvarying vec3 fragNormal;\nvoid main(void) {\n    gl_FragColor = vec4((fragNormal+1.0)/2.0, 1.0);\n}\n"};(function(){var b={},a={};b.register=function(b,d){a[b]=d;d.name=b};b.getScript=function(b){return a[b]};XML3D.xflow=b})();XML3D.xflow.register("morph3",{outputs:[{name:"result",tupleSize:"3"}],params:["value","valueAdd","weight"],evaluate:function(b,a,c){if(!b||!a||!c)throw"Xflow::morph3: Not all parameters are set";if(b.length!=a.length)throw"Xflow::morph3: Input arrays differ in size";this.result=new Float32Array(b.length);for(var d=0;d<b.length;d++)this.result[d]=b[d]+c[0]*a[d];return!0}});XML3D.xflow.register("sub3",{outputs:[{name:"result",tupleSize:"3"}],params:["value1","value2"],evaluate:function(b,a){if(!b||!a)throw"Xflow::sub3: Not all parameters are set";if(b.length!=b.length)throw"Xflow::sub3: Input arrays differ in size";this.result=new Float32Array(b.length);for(var c=0;c<b.length;c++)this.result[c]=b[c]-a[c];return!0}});XML3D.xflow.register("normalize3",{outputs:[{name:"result",tupleSize:"3"}],params:["value"],evaluate:function(b){if(!b)throw"Xflow::normalize: Not input";this.result&&this.result.length==b.length||(this.result=new Float32Array(b.length));for(var a=0;a<b.length/3;a++){var c=3*a,d=b[c],e=b[c+1],g=b[c+2],f=1/Math.sqrt(d*d+e*e+g*g);this.result[c]=d*f;this.result[c+1]=e*f;this.result[c+2]=g*f}return!0}});XML3D.xflow.register("lerp3Seq",{outputs:[{name:"result",tupleSize:"3"}],params:["sequence","weight"],evaluate:function(b,a){this.result=b.interpolate(a[0],function(a,b,e){for(var g=new Float32Array(a.length),f=1-e,h=0;h<a.length;h++)g[h]=a[h]*f+b[h]*e;return g});return!0}});XML3D.xflow.register("slerpSeq",{outputs:[{name:"result",tupleSize:"3"}],params:["sequence","weight"],evaluate:function(b,a){this.result=b.interpolate(a[0],function(a,b,e){for(var g=a.length,f=new Float32Array(g),h=0;h<g/4;h++)quat4.slerpOffset(a,b,4*h,e,f,!0);return f});return!0}});XML3D.xflow.register("createTransform",{outputs:[{name:"result",tupleSize:"16"}],params:["translation","rotation","scale","center","scaleOrientation"],evaluate:function(b,a,c,d,e){var a=a.data?a.data[0].getValue():a,g=b?b.length/3:a?a.length/4:c?c.length/3:d?d.length/3:e?e/4:0;if(!g)throw"createTransform: No input found";this.result=this.result||new Float32Array(16*g);for(var f=0;f<g;f++)mat4.makeTransformOffset(b,a,c,d,e,f,this.result);return!0}});XML3D.xflow.register("mul4x4",{outputs:[{name:"result",tupleSize:"16"}],params:["value1","value2"],evaluate:function(b,a){if(!b||!a)throw"Xflow::mul4x4: Not all parameters are set";if(b.length!=b.length)throw"Xflow::mul4x4: Input arrays differ in size";for(var c=this.result||new Float32Array(b.length),d=b.length/16,e=0;e<d;e++){var g=16*e;mat4.multiplyOffset(c,g,b,g,a,g)}this.result=c;return!0}});XML3D.xflow.register("skinDirection",{outputs:[{name:"result",tupleSize:"3"}],params:["dir","boneIdx","boneWeight","boneXform"],evaluate:function(b,a,c,d){var e=b.length/3,g=new Float32Array(b.length);mat4.create();for(var f=vec3.create(),h=vec3.create(),i=0;i<e;i++){for(var j=3*i,k=f[0]=f[1]=f[2]=0;4>k;k++){var l=c[4*i+k];l&&(mat4.multiplyOffsetDirection(d,16*a[4*i+k],b,j,h),vec3.scale(h,l),vec3.add(f,h))}g[j]=f[0];g[j+1]=f[1];g[j+2]=f[2]}this.result=g;return!0}});XML3D.xflow.register("skinPosition",{outputs:[{name:"result",tupleSize:"3"}],params:["pos","boneIdx","boneWeight","boneXform"],evaluate:function(b,a,c,d){var e=b.length/3,g=new Float32Array(b.length);mat4.create();for(var f=vec3.create(),h=vec3.create(),i=0;i<e;i++){for(var j=3*i,k=f[0]=f[1]=f[2]=0;4>k;k++){var l=c[4*i+k];l&&(mat4.multiplyOffsetVec3(d,16*a[4*i+k],b,j,h),vec3.scale(h,l),vec3.add(f,h))}g[j]=f[0];g[j+1]=f[1];g[j+2]=f[2]}this.result=g;return!0}});XML3D.xflow.register("flattenBoneTransform",{outputs:[{name:"result",tupleSize:"16"}],params:["parent","xform"],evaluate:function(b,a){for(var c=a.length/16,d=new Float32Array(16*c),e=[],g=0;g<c;){if(!e[g]){var f=b[g];if(0<=f)if(e[f])mat4.multiplyOffset(d,16*g,a,16*g,d,16*f);else{for(;0<=b[f]&&!e[b[f]];)f=b[f];if(0<=b[f])mat4.multiplyOffset(d,16*f,a,16*f,d,16*b[f]);else for(var h=0;16>h;h++)d[16*f+h]=a[16*f+h];e[f]=!0;continue}else for(h=0;16>h;h++)d[16*g+h]=a[16*g+h];e[g]=!0}g++}this.result=d;return!0}});XML3D.xflow.register("flipNormal",{outputs:[{name:"result",tupleSize:"3"}],params:["value"],evaluate:function(b){if(!b)throw"Xflow::flipNormal: Not all parameters are set";this.result=new Float32Array(b.length);for(var a=0;a<b.length;a++)this.result[a]=-b[a];return!0}});mat4.multiplyOffsetVec3=function(b,a,c,d,e){e||(e=c);d||(d=0);var g=c[d+0],f=c[d+1],c=c[d+2];e[0]=b[a+0]*g+b[a+4]*f+b[a+8]*c+b[a+12];e[1]=b[a+1]*g+b[a+5]*f+b[a+9]*c+b[a+13];e[2]=b[a+2]*g+b[a+6]*f+b[a+10]*c+b[a+14];return e};mat4.multiplyOffsetDirection=function(b,a,c,d,e){e||(e=c);d||(d=0);var g=c[d+0],f=c[d+1],c=c[d+2];e[0]=b[a+0]*g+b[a+4]*f+b[a+8]*c;e[1]=b[a+1]*g+b[a+5]*f+b[a+9]*c;e[2]=b[a+2]*g+b[a+6]*f+b[a+10]*c;return e};
mat4.makeTransformOffset=function(b,a,c,d,e,g,f){c=16*g;d=3*g;g*=4;f[c+0]=1;f[c+1]=0;f[c+2]=0;f[c+3]=0;f[c+4]=0;f[c+5]=1;f[c+6]=0;f[c+7]=0;f[c+8]=0;f[c+9]=0;f[c+10]=1;f[c+11]=0;f[c+12]=b[d];f[c+13]=b[d+1];f[c+14]=b[d+2];f[c+15]=1;a&&(b=quat4.toMat4([a[g+1],a[g+2],a[g+3],-a[g]]),mat4.multiplyOffset(f,c,b,0,f,c))};
mat4.multiplyOffset=function(b,a,c,d,e,g){var f=e[g+0],h=e[g+1],i=e[g+2],j=e[g+3],k=e[g+4],l=e[g+5],n=e[g+6],o=e[g+7],m=e[g+8],p=e[g+9],r=e[g+10],u=e[g+11],v=e[g+12],s=e[g+13],w=e[g+14],e=e[g+15],g=c[d+0],t=c[d+1],q=c[d+2],y=c[d+3],z=c[d+4],A=c[d+5],B=c[d+6],C=c[d+7],D=c[d+8],E=c[d+9],x=c[d+10],F=c[d+11],G=c[d+12],H=c[d+13],I=c[d+14],c=c[d+15];b[a+0]=g*f+t*k+q*m+y*v;b[a+1]=g*h+t*l+q*p+y*s;b[a+2]=g*i+t*n+q*r+y*w;b[a+3]=g*j+t*o+q*u+y*e;b[a+4]=z*f+A*k+B*m+C*v;b[a+5]=z*h+A*l+B*p+C*s;b[a+6]=z*i+A*n+B*
r+C*w;b[a+7]=z*j+A*o+B*u+C*e;b[a+8]=D*f+E*k+x*m+F*v;b[a+9]=D*h+E*l+x*p+F*s;b[a+10]=D*i+E*n+x*r+F*w;b[a+11]=D*j+E*o+x*u+F*e;b[a+12]=G*f+H*k+I*m+c*v;b[a+13]=G*h+H*l+I*p+c*s;b[a+14]=G*i+H*n+I*r+c*w;b[a+15]=G*j+H*o+I*u+c*e};
quat4.slerpOffset=function(b,a,c,d,e,g){e||(e=b);var f=c+1,h=c+2,i=c+3,j=b[c]*a[c]+b[f]*a[f]+b[h]*a[h]+b[i]*a[i],k;if(0.01>1-Math.abs(j))k=1-d;else{var l=Math.acos(Math.abs(j)),n=Math.sin(l);k=Math.sin(l*(1-d))/n;d=Math.sin(l*d)/n}g&&0>j&&(k=-k);e[c]=k*b[c]+d*a[c];e[f]=k*b[f]+d*a[f];e[h]=k*b[h]+d*a[h];e[i]=k*b[i]+d*a[i]};var SimplexNoise=function(b){void 0==b&&(b=Math);this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]];this.p=[];for(var a=0;256>a;a++)this.p[a]=Math.floor(256*b.random());this.perm=[];for(a=0;512>a;a++)this.perm[a]=this.p[a&255];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],
[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]};
SimplexNoise.prototype.dot=function(b,a,c){return b[0]*a+b[1]*c};
SimplexNoise.prototype.noise=function(b,a){var c,d,e;e=0.5*(Math.sqrt(3)-1);e*=b+a;var g=Math.floor(b+e),f=Math.floor(a+e),h=(3-Math.sqrt(3))/6;e=(g+f)*h;c=b-(g-e);var i=a-(f-e),j,k;c>i?(j=1,k=0):(j=0,k=1);d=c-j+h;var l=i-k+h;e=c-1+2*h;var h=i-1+2*h,n=g&255,f=f&255,g=this.perm[n+this.perm[f]]%12;j=this.perm[n+j+this.perm[f+k]]%12;k=this.perm[n+1+this.perm[f+1]]%12;f=0.5-c*c-i*i;0>f?c=0:(f*=f,c=f*f*this.dot(this.grad3[g],c,i));i=0.5-d*d-l*l;0>i?d=0:(i*=i,d=i*i*this.dot(this.grad3[j],d,l));l=0.5-e*
e-h*h;0>l?e=0:(l*=l,e=l*l*this.dot(this.grad3[k],e,h));return 70*(c+d+e)};
SimplexNoise.prototype.noise3d=function(b,a,c){var d,e,g,f=(b+a+c)*(1/3),h=Math.floor(b+f),i=Math.floor(a+f),j=Math.floor(c+f),f=1/6;g=(h+i+j)*f;d=b-(h-g);e=a-(i-g);var k=c-(j-g),l,n,o,m,p,r;d>=e?e>=k?(l=1,o=n=0,p=m=1,r=0):(d>=k?(l=1,o=n=0):(n=l=0,o=1),m=1,p=0,r=1):e<k?(n=l=0,o=1,m=0,r=p=1):d<k?(l=0,n=1,m=o=0,r=p=1):(l=0,n=1,o=0,p=m=1,r=0);var u=d-l+f,v=e-n+f,s=k-o+f;g=d-m+2*f;var b=e-p+2*f,w=k-r+2*f,c=d-1+3*f,a=e-1+3*f,f=k-1+3*f,h=h&255,t=i&255,q=j&255,i=this.perm[h+this.perm[t+this.perm[q]]]%12,
j=this.perm[h+l+this.perm[t+n+this.perm[q+o]]]%12;m=this.perm[h+m+this.perm[t+p+this.perm[q+r]]]%12;h=this.perm[h+1+this.perm[t+1+this.perm[q+1]]]%12;p=0.6-d*d-e*e-k*k;0>p?d=0:(p*=p,d=p*p*this.dot(this.grad3[i],d,e,k));e=0.6-u*u-v*v-s*s;0>e?e=0:(e*=e,e=e*e*this.dot(this.grad3[j],u,v,s));u=0.6-g*g-b*b-w*w;0>u?g=0:(u*=u,g=u*u*this.dot(this.grad3[m],g,b,w));b=0.6-c*c-a*a-f*f;0>b?c=0:(b*=b,c=b*b*this.dot(this.grad3[h],c,a,f));return 32*(d+e+g+c)};XML3D.xflow.register("noiseImage",{outputs:[{name:"image",tupleSize:"1"}],params:["width","height","scale","minFreq","maxFreq"],evaluate:function(b,a,c,d,e){var g=document.createElement("canvas"),b=b[0],a=a[0],d=d[0],e=e[0];g.width=b;g.height=a;var f=g.getContext("2d");if(!f)throw"Could not create 2D context.";for(var h=f.getImageData(0,0,b,a),i=h.data,j=this.noise=this.noise||new SimplexNoise,k=0!=d&&0!=e&&d<e,l=0;l<a;++l)for(var n=l/a*c[1],o=1/b,m=0;m<b;++m){var p=m*o*c[0],r;if(k){r=e;for(var u=
n,v=0,s=d;s<r;s*=2)v+=Math.abs(2*j.noise(p*s,u*s)-1)/s;r=v}else r=2*j.noise(p,n)-1;p=4*(m*b+l);i[p]=Math.floor(255*r);i[p+1]=Math.floor(255*r);i[p+2]=Math.floor(255*r);i[p+3]=255}f.putImageData(h,0,0);this.image=g;return!0}});